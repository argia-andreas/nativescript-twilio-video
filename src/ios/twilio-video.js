"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var observable_1 = require("tns-core-modules/data/observable");
var delegates_1 = require("./delegates");
var VideoActivity = (function () {
    function VideoActivity() {
        this._roomDelegate = delegates_1.RoomDelegate.initWithOwner(new WeakRef(this), this);
        this._participantDelegate = delegates_1.RemoteParticipantDelegate.initWithOwner(new WeakRef(this), this);
    }
    VideoActivity.prototype.start_preview = function () {
        this.notify('start_preview');
        this.camera = TVICameraCapturer.alloc().initWithSource(TVICameraCaptureSourceFrontCamera);
        this.localVideoTrack = TVILocalVideoTrack.trackWithCapturer(this.camera);
        if (!this.localVideoTrack) {
            this.notify('Failed to add video track');
        }
        else {
            this.localVideoTrack.addRenderer(this.localVideoView);
        }
    };
    VideoActivity.prototype.disconnect = function () {
        if (this.room) {
            this.notify('disconnect');
            this.room.disconnect();
        }
    };
    VideoActivity.prototype.toggle_local_video = function () {
        if (this.localVideoTrack) {
            this.localVideoTrack.enabled = !this.localVideoTrack.enable;
        }
    };
    VideoActivity.prototype.toggle_local_audio = function () {
        if (this.localAudioTrack) {
            this.localAudioTrack.enabled = !this.localAudioTrack.enabled;
        }
    };
    VideoActivity.prototype.connect_to_room = function (room, options) {
        var _this = this;
        if (!this.accessToken) {
            this.notify('Please provide a valid token to connect to a room');
            return;
        }
        if (!this.localAudioTrack && options.audio) {
            this.localAudioTrack = TVILocalAudioTrack.track();
        }
        if (!this.localVideoTrack && options.video) {
            this.start_preview();
        }
        var connectOptions = TVIConnectOptions.optionsWithTokenBlock(this.accessToken, function (builder) {
            if (options.audio)
                builder.audioTracks = [_this.localAudioTrack];
            if (options.video)
                builder.videoTracks = [_this.localVideoTrack];
            builder.roomName = room;
        });
        this.room = TwilioVideo.connectWithOptionsDelegate(connectOptions, this._roomDelegate);
    };
    VideoActivity.prototype.cleanupRemoteParticipant = function () {
        if (this.remoteParticipant) {
            if (this.remoteParticipant.videoTracks.count > 0) {
                var videoTrack = this.remoteParticipant.remoteVideoTracks[0].remoteTrack;
                try {
                    videoTrack.removeRenderer(this.remoteVideoView);
                }
                catch (e) {
                    console.log(e);
                    this.notify(e);
                }
            }
        }
    };
    VideoActivity.prototype.notify = function (reason) {
        this.event.notify({
            eventName: 'error',
            object: observable_1.fromObject({
                reason: reason
            })
        });
    };
    VideoActivity.prototype.connectToRoomWithListener = function (room) {
        if (room.remoteParticipants.count > 0) {
            this.remoteParticipant = room.remoteParticipants[0];
            this.remoteParticipant.delegate = this._participantDelegate;
        }
    };
    VideoActivity.prototype.participant_joined_room = function (participant) {
        if (!this.remoteParticipant) {
            this.remoteParticipant = participant;
            this.remoteParticipant.delegate = this._participantDelegate;
        }
    };
    VideoActivity.prototype.set_access_token = function (token) {
        this.accessToken = token;
    };
    VideoActivity.prototype.remove_remote_view = function (videoTrack, participant) {
        if (this.remoteParticipant == participant) {
            console.log('remove_remote_view');
            videoTrack.removeRenderer(this.remoteVideoView);
        }
    };
    VideoActivity.prototype.add_video_track = function (videoTrack) {
        videoTrack.addRenderer(this.remoteVideoView);
    };
    VideoActivity.prototype.destroy_local_video = function () {
        this.localVideoTrack.removeRenderer(this.localVideoView);
    };
    VideoActivity.prototype.configure_audio = function (enable) {
        if (!this.localAudioTrack) {
            this.localAudioTrack = TVILocalAudioTrack.track();
            if (!this.localAudioTrack) {
                return 'failed to get local audio';
            }
        }
    };
    Object.defineProperty(VideoActivity.prototype, "event", {
        get: function () {
            return delegates_1.DelegateEvents._event;
        },
        enumerable: true,
        configurable: true
    });
    return VideoActivity;
}());
exports.VideoActivity = VideoActivity;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHdpbGlvLXZpZGVvLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidHdpbGlvLXZpZGVvLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBR0EsK0RBQTBFO0FBRTFFLHlDQUE4RztBQWM5RztJQXNCSTtRQU1JLElBQUksQ0FBQyxhQUFhLEdBQUcsd0JBQVksQ0FBQyxhQUFhLENBQUMsSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFekUsSUFBSSxDQUFDLG9CQUFvQixHQUFHLHFDQUF5QixDQUFDLGFBQWEsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUVqRyxDQUFDO0lBc0JKLHFDQUFhLEdBQWI7UUFHQyxJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxNQUFNLEdBQUcsaUJBQWlCLENBQUMsS0FBSyxFQUFFLENBQUMsY0FBYyxDQUFDLGlDQUFpQyxDQUFDLENBQUM7UUFFMUYsSUFBSSxDQUFDLGVBQWUsR0FBRyxrQkFBa0IsQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFekUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztZQUV4QixJQUFJLENBQUMsTUFBTSxDQUFDLDJCQUEyQixDQUFDLENBQUM7UUFFN0MsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBRUosSUFBSSxDQUFDLGVBQWUsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBRTFELENBQUM7SUFFTCxDQUFDO0lBRUQsa0NBQVUsR0FBVjtRQUNJLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBQ3JCLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDakIsSUFBSSxDQUFDLElBQUksQ0FBQyxV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QUExQjtRQUVJLElBQUksQ0FBQyxlQUFlLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUU3RCxDQUFDO0lBR00sdUNBQWUsR0FBdEIsVUFBdUIsTUFBZTtRQUtsQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDO1lBRXhCLElBQUksQ0FBQyxlQUFlLEdBQUcsa0JBQWtCLENBQUMsS0FBSyxFQUFFLENBQUM7WUFFbEQsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztnQkFFeEIsTUFBTSxDQUFDLDJCQUEyQixDQUFDO1lBRXZDLENBQUM7UUFFTCxDQUFDO0lBRUwsQ0FBQztJQUlELHNCQUFJLGdDQUFLO2FBQVQ7WUFFSSxNQUFNLENBQUMsMEJBQWMsQ0FBQyxNQUFNLENBQUM7UUFFakMsQ0FBQzs7O09BQUE7SUFLTCxvQkFBQztBQUFELENBQUMsQUEzUUQsSUEyUUM7QUEzUVksc0NBQWEiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCB7IFJlbW90ZVZpZGVvIH0gZnJvbSBcIi4vcmVtb3RlVmlkZW9cIjtcbmltcG9ydCB7IExvY2FsVmlkZW8gfSBmcm9tIFwiLi9sb2NhbFZpZGVvXCI7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBmcm9tT2JqZWN0IH0gZnJvbSAndG5zLWNvcmUtbW9kdWxlcy9kYXRhL29ic2VydmFibGUnO1xuaW1wb3J0IHsgVmlkZW9BY3Rpdml0eUJhc2UgfSBmcm9tIFwiLi4vdHdpbGlvLWNvbW1vblwiO1xuaW1wb3J0IHsgUm9vbURlbGVnYXRlLCBSZW1vdGVQYXJ0aWNpcGFudERlbGVnYXRlLCBEZWxlZ2F0ZUV2ZW50cywgQ2FtZXJhQ2FwdHVyZXJEZWxlZ2F0ZSB9IGZyb20gXCIuL2RlbGVnYXRlc1wiO1xuaW1wb3J0ICogYXMgYXBwbGljYXRpb24gZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvYXBwbGljYXRpb25cIjtcblxuZGVjbGFyZSB2YXIgVFZJQ29ubmVjdE9wdGlvbnMsXG4gICAgVFZJQ2FtZXJhQ2FwdHVyZXIsXG4gICAgVFZJTG9jYWxWaWRlb1RyYWNrLFxuICAgIFRWSVJlbW90ZVBhcnRpY2lwYW50LFxuICAgIFR3aWxpb1ZpZGVvLFxuICAgIFRWSUxvY2FsQXVkaW9UcmFjayxcbiAgICBUVklSb29tLFxuICAgIFRWSVZpZGVvVmlldyxcbiAgICBUVklDYW1lcmFDYXB0dXJlU291cmNlRnJvbnRDYW1lcmE7XG5cblxuZXhwb3J0IGNsYXNzIFZpZGVvQWN0aXZpdHkgaW1wbGVtZW50cyBWaWRlb0FjdGl2aXR5QmFzZSB7XG5cbiAgICBsb2NhbFZpZGVvVmlldzogYW55O1xuICAgIHJlbW90ZVZpZGVvVmlldzogYW55O1xuICAgIGxvY2FsVmlkZW9UcmFjazogYW55O1xuICAgIGxvY2FsQXVkaW9UcmFjazogYW55O1xuICAgIGNhbWVyYUNhcHR1cmVyOiBhbnk7XG4gICAgcHJpdmF0ZSBfY2FtZXJhQ2FwdHVyZXJEZWxlZ2F0ZTogYW55O1xuICAgIGFjY2Vzc1Rva2VuOiBzdHJpbmc7XG4gICAgcm9vbU9iajogYW55O1xuICAgIHByZXZpb3VzTWljcm9waG9uZU11dGU6IGJvb2xlYW47XG4gICAgbG9jYWxQYXJ0aWNpcGFudDogYW55O1xuICAgIHJlbW90ZVBhcnRpY2lwYW50OiBhbnk7XG4gICAgcHJpdmF0ZSBfcm9vbUxpc3RlbmVyOiBhbnk7XG4gICAgcHJpdmF0ZSBfcGFydGljaXBhbnREZWxlZ2F0ZTogYW55O1xuICAgIHByaXZhdGUgX3Jvb21EZWxlZ2F0ZTogYW55O1xuICAgIHBhcnRpY2lwYW50OiBhbnk7XG4gICAgLy8gZXZlbnQ6IE9ic2VydmFibGU7XG4gICAgcm9vbTogYW55O1xuICAgIGNhbWVyYTogYW55O1xuICAgIHRlc3Q6IHN0cmluZztcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuXG4gICAgICAgIC8vIHRoaXMuZXZlbnQgPSBuZXcgT2JzZXJ2YWJsZSgpO1xuXG4gICAgICAgIC8vIHRoaXMuX2NhbWVyYUNhcHR1cmVyRGVsZWdhdGUgPSBDYW1lcmFDYXB0dXJlckRlbGVnYXRlLmluaXRXaXRoT3duZXIobmV3IFdlYWtSZWYodGhpcykpO1xuXG4gICAgICAgIHRoaXMuX3Jvb21EZWxlZ2F0ZSA9IFJvb21EZWxlZ2F0ZS5pbml0V2l0aE93bmVyKG5ldyBXZWFrUmVmKHRoaXMpLCB0aGlzKTtcblxuICAgICAgICB0aGlzLl9wYXJ0aWNpcGFudERlbGVnYXRlID0gUmVtb3RlUGFydGljaXBhbnREZWxlZ2F0ZS5pbml0V2l0aE93bmVyKG5ldyBXZWFrUmVmKHRoaXMpLCB0aGlzKTtcblxuICAgIH1cblxuICAgIC8vIHB1YmxpYyByZW1vdmVfdmlkZW9fY2hhdF90d2lsaW9fbGlzdGVuZXJzKCk6IHZvaWQge1xuXG4gICAgLy8gICAgIHRoaXMuZXZlbnQub2ZmKCdvbkNvbm5lY3RlZCcpO1xuICAgIC8vICAgICB0aGlzLmV2ZW50Lm9mZignb25QYXJ0aWNpcGFudENvbm5lY3RlZCcpO1xuICAgIC8vICAgICB0aGlzLmV2ZW50Lm9mZignb25WaWRlb1RyYWNrQWRkZWQnKTtcbiAgICAvLyAgICAgdGhpcy5ldmVudC5vZmYoJ29uRGlzY29ubmVjdGVkJyk7XG4gICAgLy8gICAgIHRoaXMuZXZlbnQub2ZmKCdvbkNvbm5lY3RGYWlsdXJlJyk7XG4gICAgLy8gICAgIHRoaXMuZXZlbnQub2ZmKCdvblBhcnRpY2lwYW50RGlzY29ubmVjdGVkJyk7XG4gICAgLy8gICAgIHRoaXMuZXZlbnQub2ZmKCdvbkF1ZGlvVHJhY2tBZGRlZCcpO1xuICAgIC8vICAgICB0aGlzLmV2ZW50Lm9mZignb25WaWRlb1RyYWNrUmVtb3ZlZCcpO1xuICAgIC8vICAgICB0aGlzLmV2ZW50Lm9mZignb25BdWRpb1RyYWNrRW5hYmxlZCcpO1xuICAgIC8vICAgICB0aGlzLmV2ZW50Lm9mZignb25BdWRpb1RyYWNrRGlzYWJsZWQnKTtcbiAgICAvLyAgICAgdGhpcy5ldmVudC5vZmYoJ29uVmlkZW9UcmFja0VuYWJsZWQnKTtcbiAgICAvLyAgICAgdGhpcy5ldmVudC5vZmYoJ29uVmlkZW9UcmFja0Rpc2FibGVkJyk7XG4gICAgLy8gICAgIHRoaXMuZXZlbnQub2ZmKCdzdWJzY3JpYmVkVG9WaWRlb1RyYWNrUHVibGljYXRpb25Gb3JQYXJ0aWNpcGFudCcpO1xuICAgIC8vICAgICB0aGlzLmV2ZW50Lm9mZigndW5zdWJzY3JpYmVkRnJvbVZpZGVvVHJhY2tQdWJsaWNhdGlvbkZvclBhcnRpY2lwYW50Jyk7XG4gICAgLy8gfVxuXG5cblxuXHRzdGFydF9wcmV2aWV3KCkge1xuICAgICAgICAvLyBUVklDYW1lcmFDYXB0dXJlciBpcyBub3Qgc3VwcG9ydGVkIHdpdGggdGhlIFNpbXVsYXRvci5cbiAgICAgICAgLy8gdGhpcy5jYW1lcmEgPSBUVklDYW1lcmFDYXB0dXJlci5hbGxvYygpLmluaXRXaXRoU291cmNlRGVsZWdhdGUoVFZJQ2FtZXJhQ2FwdHVyZVNvdXJjZUZyb250Q2FtZXJhLCB0aGlzLl9jYW1lcmFDYXB0dXJlckRlbGVnYXRlKTtcblx0XHR0aGlzLm5vdGlmeSgnc3RhcnRfcHJldmlldycpO1xuICAgICAgICB0aGlzLmNhbWVyYSA9IFRWSUNhbWVyYUNhcHR1cmVyLmFsbG9jKCkuaW5pdFdpdGhTb3VyY2UoVFZJQ2FtZXJhQ2FwdHVyZVNvdXJjZUZyb250Q2FtZXJhKTtcblxuICAgICAgICB0aGlzLmxvY2FsVmlkZW9UcmFjayA9IFRWSUxvY2FsVmlkZW9UcmFjay50cmFja1dpdGhDYXB0dXJlcih0aGlzLmNhbWVyYSk7XG5cbiAgICAgICAgaWYgKCF0aGlzLmxvY2FsVmlkZW9UcmFjaykge1xuXG4gICAgICAgICAgICB0aGlzLm5vdGlmeSgnRmFpbGVkIHRvIGFkZCB2aWRlbyB0cmFjaycpO1xuXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBBZGQgcmVuZGVyZXIgdG8gdmlkZW8gdHJhY2sgZm9yIGxvY2FsIHByZXZpZXdcbiAgICAgICAgICAgIHRoaXMubG9jYWxWaWRlb1RyYWNrLmFkZFJlbmRlcmVyKHRoaXMubG9jYWxWaWRlb1ZpZXcpO1xuXG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIGRpc2Nvbm5lY3QoKSB7XG4gICAgICAgIGlmICh0aGlzLnJvb20pIHtcblx0XHRcdHRoaXMubm90aWZ5KCdkaXNjb25uZWN0Jyk7XG4gICAgICAgICAgICB0aGlzLnJvb20uZGlzY29ubmVjdCgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHVibGljIHRvZ2dsZV9sb2NhbF92aWRlbygpIHtcblxuICAgICAgICBpZiAodGhpcy5sb2NhbFZpZGVvVHJhY2spIHtcblxuICAgICAgICAgICAgdGhpcy5sb2NhbFZpZGVvVHJhY2suZW5hYmxlZCA9ICF0aGlzLmxvY2FsVmlkZW9UcmFjay5lbmFibGU7XG5cbiAgICAgICAgfVxuXG4gICAgfVxuXG4gICAgcHVibGljIHRvZ2dsZV9sb2NhbF9hdWRpbygpIHtcblxuICAgICAgICBpZiAodGhpcy5sb2NhbEF1ZGlvVHJhY2spIHtcblxuICAgICAgICAgICAgdGhpcy5sb2NhbEF1ZGlvVHJhY2suZW5hYmxlZCA9ICF0aGlzLmxvY2FsQXVkaW9UcmFjay5lbmFibGVkO1xuXG4gICAgICAgIH1cblxuICAgIH1cblxuICAgIGNvbm5lY3RfdG9fcm9vbShyb29tOiBzdHJpbmcsIG9wdGlvbnM6IHsgdmlkZW86IGJvb2xlYW4sIGF1ZGlvOiBib29sZWFuIH0pOiB2b2lkIHtcblxuICAgICAgICBpZiAoIXRoaXMuYWNjZXNzVG9rZW4pIHtcblxuICAgICAgICAgICAgdGhpcy5ub3RpZnkoJ1BsZWFzZSBwcm92aWRlIGEgdmFsaWQgdG9rZW4gdG8gY29ubmVjdCB0byBhIHJvb20nKTtcblxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIH1cblxuICAgICAgICAvLyBQcmVwYXJlIGxvY2FsIG1lZGlhIHdoaWNoIHdlIHdpbGwgc2hhcmUgd2l0aCBSb29tIFBhcnRpY2lwYW50cy5cbiAgICAgICAgaWYgKCF0aGlzLmxvY2FsQXVkaW9UcmFjayAmJiBvcHRpb25zLmF1ZGlvKSB7XG4gICAgICAgICAgICB0aGlzLmxvY2FsQXVkaW9UcmFjayA9IFRWSUxvY2FsQXVkaW9UcmFjay50cmFjaygpO1xuICAgICAgICB9XG5cblxuICAgICAgICAvLyBDcmVhdGUgYSB2aWRlbyB0cmFjayB3aGljaCBjYXB0dXJlcyBmcm9tIHRoZSBjYW1lcmEuXG4gICAgICAgIGlmICghdGhpcy5sb2NhbFZpZGVvVHJhY2sgJiYgb3B0aW9ucy52aWRlbykge1xuICAgICAgICAgICAgdGhpcy5zdGFydF9wcmV2aWV3KCk7XG4gICAgICAgIH1cblxuXG4gICAgICAgIHZhciBjb25uZWN0T3B0aW9ucyA9IFRWSUNvbm5lY3RPcHRpb25zLm9wdGlvbnNXaXRoVG9rZW5CbG9jayh0aGlzLmFjY2Vzc1Rva2VuLCAoYnVpbGRlcikgPT4ge1xuXG5cbiAgICAgICAgICAgIC8vIFVzZSB0aGUgbG9jYWwgbWVkaWEgdGhhdCB3ZSBwcmVwYXJlZCBlYXJsaWVyLlxuICAgICAgICAgICAgaWYgKG9wdGlvbnMuYXVkaW8pXG4gICAgICAgICAgICAgICAgYnVpbGRlci5hdWRpb1RyYWNrcyA9IFt0aGlzLmxvY2FsQXVkaW9UcmFja107XG5cbiAgICAgICAgICAgIGlmIChvcHRpb25zLnZpZGVvKVxuICAgICAgICAgICAgICAgIGJ1aWxkZXIudmlkZW9UcmFja3MgPSBbdGhpcy5sb2NhbFZpZGVvVHJhY2tdO1xuXG4gICAgICAgICAgICAvLyBUaGUgbmFtZSBvZiB0aGUgUm9vbSB3aGVyZSB0aGUgQ2xpZW50IHdpbGwgYXR0ZW1wdCB0byBjb25uZWN0IHRvLiBQbGVhc2Ugbm90ZSB0aGF0IGlmIHlvdSBwYXNzIGFuIGVtcHR5XG4gICAgICAgICAgICAvLyBSb29tIGBuYW1lYCwgdGhlIENsaWVudCB3aWxsIGNyZWF0ZSBvbmUgZm9yIHlvdS4gWW91IGNhbiBnZXQgdGhlIG5hbWUgb3Igc2lkIGZyb20gYW55IGNvbm5lY3RlZCBSb29tLlxuICAgICAgICAgICAgYnVpbGRlci5yb29tTmFtZSA9IHJvb207XG5cblxuICAgICAgICB9KTtcblxuXG5cbiAgICAgICAgLy8gQ29ubmVjdCB0byB0aGUgUm9vbSB1c2luZyB0aGUgb3B0aW9ucyB3ZSBwcm92aWRlZC5cbiAgICAgICAgdGhpcy5yb29tID0gVHdpbGlvVmlkZW8uY29ubmVjdFdpdGhPcHRpb25zRGVsZWdhdGUoY29ubmVjdE9wdGlvbnMsIHRoaXMuX3Jvb21EZWxlZ2F0ZSk7XG5cbiAgICAgICAgLy8gW3NlbGYgbG9nTWVzc2FnZTpbTlNTdHJpbmcgc3RyaW5nV2l0aEZvcm1hdDpAXCJBdHRlbXB0aW5nIHRvIGNvbm5lY3QgdG8gcm9vbSAlQFwiLCBzZWxmLnJvb21UZXh0RmllbGQudGV4dF1dO1xuXG4gICAgfVxuXG5cbiAgICBjbGVhbnVwUmVtb3RlUGFydGljaXBhbnQoKSB7XG4gICAgICAgIGlmICh0aGlzLnJlbW90ZVBhcnRpY2lwYW50KSB7XG4gICAgICAgICAgICBpZiAodGhpcy5yZW1vdGVQYXJ0aWNpcGFudC52aWRlb1RyYWNrcy5jb3VudCA+IDApIHtcbiAgICAgICAgICAgICAgICB2YXIgdmlkZW9UcmFjayA9IHRoaXMucmVtb3RlUGFydGljaXBhbnQucmVtb3RlVmlkZW9UcmFja3NbMF0ucmVtb3RlVHJhY2s7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgdmlkZW9UcmFjay5yZW1vdmVSZW5kZXJlcih0aGlzLnJlbW90ZVZpZGVvVmlldyk7XG4gICAgICAgICAgICAgICAgICAgIC8vIHRoaXMucmVtb3RlVmlkZW9WaWV3LnJlbW92ZUZyb21TdXBlcnZpZXcoKTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm5vdGlmeShlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyB0aGlzLnJlbW90ZVBhcnRpY2lwYW50ID0gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG5vdGlmeShyZWFzb246IHN0cmluZykge1xuXG4gICAgICAgIHRoaXMuZXZlbnQubm90aWZ5KHtcbiAgICAgICAgICAgIGV2ZW50TmFtZTogJ2Vycm9yJyxcbiAgICAgICAgICAgIG9iamVjdDogZnJvbU9iamVjdCh7XG4gICAgICAgICAgICAgICAgcmVhc29uOiByZWFzb25cbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pO1xuXG4gICAgfVxuXG5cblxuXG4gICAgcHVibGljIGNvbm5lY3RUb1Jvb21XaXRoTGlzdGVuZXIocm9vbSkgeyAvLyBydW5zIGZyb20gb25Db25uZWN0ZWQvZGlkQ29ubmVjdFRvUm9vbVxuXG4gICAgICAgIGlmIChyb29tLnJlbW90ZVBhcnRpY2lwYW50cy5jb3VudCA+IDApIHtcblxuICAgICAgICAgICAgdGhpcy5yZW1vdGVQYXJ0aWNpcGFudCA9IHJvb20ucmVtb3RlUGFydGljaXBhbnRzWzBdO1xuXG4gICAgICAgICAgICB0aGlzLnJlbW90ZVBhcnRpY2lwYW50LmRlbGVnYXRlID0gdGhpcy5fcGFydGljaXBhbnREZWxlZ2F0ZTtcblxuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgcGFydGljaXBhbnRfam9pbmVkX3Jvb20ocGFydGljaXBhbnQpIHtcblxuICAgICAgICBpZiAoIXRoaXMucmVtb3RlUGFydGljaXBhbnQpIHtcblxuICAgICAgICAgICAgdGhpcy5yZW1vdGVQYXJ0aWNpcGFudCA9IHBhcnRpY2lwYW50O1xuXG4gICAgICAgICAgICB0aGlzLnJlbW90ZVBhcnRpY2lwYW50LmRlbGVnYXRlID0gdGhpcy5fcGFydGljaXBhbnREZWxlZ2F0ZTtcblxuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgc2V0X2FjY2Vzc190b2tlbih0b2tlbjogc3RyaW5nKSB7XG5cbiAgICAgICAgdGhpcy5hY2Nlc3NUb2tlbiA9IHRva2VuO1xuXG4gICAgfVxuXG4gICAgcHVibGljIHJlbW92ZV9yZW1vdGVfdmlldyh2aWRlb1RyYWNrLCBwYXJ0aWNpcGFudCk6IHZvaWQge1xuXG4gICAgICAgIGlmICh0aGlzLnJlbW90ZVBhcnRpY2lwYW50ID09IHBhcnRpY2lwYW50KSB7XG5cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdyZW1vdmVfcmVtb3RlX3ZpZXcnKTtcblxuICAgICAgICAgICAgdmlkZW9UcmFjay5yZW1vdmVSZW5kZXJlcih0aGlzLnJlbW90ZVZpZGVvVmlldyk7XG5cbiAgICAgICAgICAgIC8vIHRoaXMucmVtb3RlVmlkZW9WaWV3LnJlbW92ZUZyb21TdXBlcnZpZXcoKTtcblxuICAgICAgICB9XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgYWRkX3ZpZGVvX3RyYWNrKHZpZGVvVHJhY2spIHtcblxuICAgICAgICB2aWRlb1RyYWNrLmFkZFJlbmRlcmVyKHRoaXMucmVtb3RlVmlkZW9WaWV3KTtcblxuICAgIH1cblxuICAgIHB1YmxpYyBkZXN0cm95X2xvY2FsX3ZpZGVvKCkge1xuXG4gICAgICAgIHRoaXMubG9jYWxWaWRlb1RyYWNrLnJlbW92ZVJlbmRlcmVyKHRoaXMubG9jYWxWaWRlb1ZpZXcpO1xuXG4gICAgfVxuXG5cbiAgICBwdWJsaWMgY29uZmlndXJlX2F1ZGlvKGVuYWJsZTogYm9vbGVhbik6IGFueSB7XG5cbiAgICAgICAgLy8gV2Ugd2lsbCBzaGFyZSBsb2NhbCBhdWRpbyBhbmQgdmlkZW8gd2hlbiB3ZSBjb25uZWN0IHRvIHJvb20uXG5cbiAgICAgICAgLy8gQ3JlYXRlIGFuIGF1ZGlvIHRyYWNrLlxuICAgICAgICBpZiAoIXRoaXMubG9jYWxBdWRpb1RyYWNrKSB7XG5cbiAgICAgICAgICAgIHRoaXMubG9jYWxBdWRpb1RyYWNrID0gVFZJTG9jYWxBdWRpb1RyYWNrLnRyYWNrKCk7XG5cbiAgICAgICAgICAgIGlmICghdGhpcy5sb2NhbEF1ZGlvVHJhY2spIHtcblxuICAgICAgICAgICAgICAgIHJldHVybiAnZmFpbGVkIHRvIGdldCBsb2NhbCBhdWRpbyc7XG5cbiAgICAgICAgICAgIH1cblxuICAgICAgICB9XG5cbiAgICB9XG5cblxuXG4gICAgZ2V0IGV2ZW50KCk6IE9ic2VydmFibGUge1xuXG4gICAgICAgIHJldHVybiBEZWxlZ2F0ZUV2ZW50cy5fZXZlbnQ7XG5cbiAgICB9XG5cblxuXG5cbn1cblxuIl19