"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var observable_1 = require("data/observable");
var app = require("tns-core-modules/application");
var nativescript_twilio_video_1 = require("nativescript-twilio-video");
var dialogs = require("ui/dialogs");
var grid_layout_1 = require("ui/layouts/grid-layout");
var http = require("http");
var permissions = require('nativescript-permissions');
var timer = require("timer");
var VideoChat = (function (_super) {
    __extends(VideoChat, _super);
    function VideoChat(page) {
        var _this = _super.call(this) || this;
        _this.page = page;
        _this.container = _this.page.getViewById('container');
        _this.videoActivity = new nativescript_twilio_video_1.VideoActivity();
        _this.localVideo = _this.page.getViewById('local-video');
        _this.remoteVideo = _this.page.getViewById('remote-video');
        _this.videoActivity.localVideoView = _this.localVideo.localVideoView;
        _this.videoActivity.remoteVideoView = _this.remoteVideo.remoteVideoView;
        _this.videoActivity.event.on('error', function (reason) {
            console.log('big error');
            console.log(reason.object['reason']);
            _this.set("error", reason.object['reason']);
            console.log(JSON.stringify(reason.object['reason']));
        });
        _this.videoActivity.event.on('didConnectToRoom', function (r) {
            console.log("didConnectToRoom");
        });
        _this.videoActivity.event.on('didFailToConnectWithError', function (r) {
            console.log("didFailToConnectWithError");
        });
        _this.videoActivity.event.on('participantDidConnect', function (r) {
            console.log("participantDidConnect");
        });
        _this.videoActivity.event.on('participantDidDisconnect', function (r) {
            console.log("participantDidDisconnect");
        });
        _this.videoActivity.event.on('participantUnpublishedAudioTrack', function (r) {
            console.log("participantUnpublishedAudioTrack");
        });
        _this.videoActivity.event.on('participantPublishedVideoTrack', function (r) {
            console.log("participantPublishedVideoTrack");
        });
        _this.videoActivity.event.on('participantUnpublishedVideoTrack', function (r) {
            console.log("participantUnpublishedVideoTrack");
        });
        _this.videoActivity.event.on('onAudioTrackSubscribed', function (r) {
            console.log("onAudioTrackSubscribed");
        });
        _this.videoActivity.event.on('onAudioTrackUnsubscribed', function (r) {
            console.log("onAudioTrackUnsubscribed");
        });
        _this.videoActivity.event.on('onVideoTrackSubscribed', function (r) {
            console.log("onVideoTrackSubscribed");
        });
        _this.videoActivity.event.on('onVideoTrackUnsubscribed', function (r) {
            console.log("onVideoTrackUnsubscribed 00");
        });
        _this.videoActivity.event.on('participantDisabledVideoTrack', function (r) {
            console.log("participantDisabledVideoTrack");
        });
        _this.videoActivity.event.on('participantEnabledVideoTrack', function (r) {
            console.log("participantEnabledVideoTrack");
        });
        _this.videoActivity.event.on('participantDisabledAudioTrack', function (r) {
            console.log("participantDisabledAudioTrack");
        });
        _this.videoActivity.event.on('participantEnabledAudioTrack', function (r) {
            console.log("participantEnabledAudioTrack");
        });
        _this.get_permissions()
            .then(function () {
            var t = timer.setTimeout(function () {
                _this.videoActivity.startPreview();
                timer.clearTimeout(t);
            }, 1200);
        });
        return _this;
    }
    VideoChat.prototype.toggle_local_video_size = function () {
        if (this.localVideo.className === 'large') {
            this.localVideo.className = 'small';
            grid_layout_1.GridLayout.setColumn(this.localVideo, 1);
            grid_layout_1.GridLayout.setRow(this.localVideo, 0);
        }
        else {
            this.localVideo.className = 'large';
            grid_layout_1.GridLayout.setColumn(this.localVideo, 0);
            grid_layout_1.GridLayout.setColumnSpan(this.localVideo, 2);
            grid_layout_1.GridLayout.setRowSpan(this.localVideo, 2);
        }
    };
    VideoChat.prototype.add_video_views = function () {
        this.localVideo.className = 'large';
        this.remoteVideo.id = 'remote-video';
        this.localVideo.on('tap', this.toggle_local_video_size.bind(this));
        grid_layout_1.GridLayout.setColumnSpan(this.remoteVideo, 2);
        grid_layout_1.GridLayout.setRowSpan(this.remoteVideo, 2);
        grid_layout_1.GridLayout.setRow(this.remoteVideo, 0);
        grid_layout_1.GridLayout.setColumnSpan(this.localVideo, 2);
        grid_layout_1.GridLayout.setRowSpan(this.localVideo, 2);
        grid_layout_1.GridLayout.setRow(this.localVideo, 0);
        this.container.insertChild(this.remoteVideo, 0);
        this.container.insertChild(this.localVideo, 0);
    };
    VideoChat.prototype.check_permissions = function () {
        var audio, camera;
        if (app.android) {
            audio = permissions.hasPermission("android.permission.RECORD_AUDIO");
            camera = permissions.hasPermission("android.permission.CAMERA");
        }
        else {
            camera = AVCaptureDevice.authorizationStatusForMediaType(AVMediaTypeVideo);
            audio = AVCaptureDevice.authorizationStatusForMediaType(AVMediaTypeAudio);
            if (camera < 3)
                camera = false;
            if (audio < 3)
                audio = false;
        }
        if (!audio || !camera)
            return false;
        else
            return true;
    };
    VideoChat.prototype.get_permissions = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            var has_permissions = _this.check_permissions();
            if (has_permissions) {
                resolve();
                return;
            }
            if (app.android) {
                permissions.requestPermissions([
                    "android.permission.RECORD_AUDIO",
                    "android.permission.CAMERA"
                ], "I need these permissions because I'm cool")
                    .then(function (response) {
                    console.dir(response);
                    resolve(response);
                })
                    .catch(function (e) {
                    console.dir(e);
                    console.log("Uh oh, no permissions - plan B time!");
                    var has_permissions = _this.check_permissions();
                    if (!has_permissions) {
                        dialogs.alert("without mic and camera permissions \n you cannot connect. \n please allow permissions in settings and try again.").then(function () {
                        });
                    }
                });
            }
            else {
                Promise.all([_this.ios_mic_permission(), _this.ios_camera_permission()])
                    .then(function (values) {
                    console.log(JSON.stringify(values));
                    resolve();
                }, function (reason) {
                    console.log(JSON.stringify(reason));
                    _this.set('error', reason);
                    dialogs.alert("without mic and camera permissions \n you cannot connect. \n please allow permissions in settings and try again.").then(function () {
                        UIApplication.sharedApplication.openURL(NSURL.URLWithString(UIApplicationOpenSettingsURLString));
                    });
                    reject();
                });
            }
        });
    };
    VideoChat.prototype.ios_mic_permission = function () {
        return new Promise(function (resolve, reject) {
            var has_asked = AVCaptureDevice.authorizationStatusForMediaType(AVMediaTypeAudio);
            if (has_asked === 2) {
                reject('mic permission denied');
                return;
            }
            AVAudioSession.sharedInstance().requestRecordPermission(function (bool) {
                if (bool === true) {
                    resolve(bool);
                    return;
                }
                reject('mic permission denied');
            });
        });
    };
    VideoChat.prototype.ios_camera_permission = function () {
        return new Promise(function (resolve, reject) {
            var has_asked = AVCaptureDevice.authorizationStatusForMediaType(AVMediaTypeVideo);
            if (has_asked === 2) {
                reject('camera permission denied');
                return;
            }
            AVCaptureDevice.requestAccessForMediaTypeCompletionHandler(AVMediaTypeVideo, function (bool) {
                if (bool === true) {
                    resolve(bool);
                    return;
                }
                reject('camera permission denied');
            });
        });
    };
    VideoChat.prototype.disconnect = function () {
        if (this.videoActivity.room) {
            this.videoActivity.disconnect();
        }
    };
    VideoChat.prototype.toggle_local_audio = function () {
        this.videoActivity.toggle_local_audio();
    };
    VideoChat.prototype.toggle_local_video = function () {
        this.videoActivity.toggle_local_video();
    };
    VideoChat.prototype.connect_to_room = function () {
        var _this = this;
        if (!this.get('name') || !this.get('room') || this.get('name').length < 1 || this.get('room').length < 1)
            return this.set('error', "Missing Info.");
        else
            this.set('error', "");
        this.get_token()
            .then(function (result) {
            var result = result.content.toJSON();
            console.log(result);
            if (result['message']) {
                _this.set('error', result['message']);
                return;
            }
            _this.videoActivity.set_access_token(result['twilioToken']);
            _this.videoActivity.connect_to_room(_this.get('room'), { video: true, audio: true });
        }, function (e) {
            _this.set('error', e);
        });
    };
    VideoChat.prototype.get_token = function () {
        var name = this.get('name');
        return http.request({
            url: 'https://651ba425.ngrok.io/twilioToken',
            method: "POST",
            headers: { "Content-Type": "application/json" },
            content: JSON.stringify({ uid: name })
        });
    };
    return VideoChat;
}(observable_1.Observable));
exports.VideoChat = VideoChat;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi12aWV3LW1vZGVsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibWFpbi12aWV3LW1vZGVsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsOENBQXlEO0FBRXpELGtEQUFvRDtBQUNwRCx1RUFBbUY7QUFDbkYsb0NBQXNDO0FBRXRDLHNEQUE4RDtBQUU5RCxJQUFNLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDN0IsSUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLDBCQUEwQixDQUFDLENBQUM7QUFDeEQsSUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBSS9CO0lBQStCLDZCQUFVO0lBV3JDLG1CQUFvQixJQUFVO1FBQTlCLFlBQ0ksaUJBQU8sU0FrR1Y7UUFuR21CLFVBQUksR0FBSixJQUFJLENBQU07UUFHMUIsS0FBSSxDQUFDLFNBQVMsR0FBZ0IsS0FBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFakUsS0FBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLHlDQUFhLEVBQUUsQ0FBQztRQUV6QyxLQUFJLENBQUMsVUFBVSxHQUFHLEtBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRXZELEtBQUksQ0FBQyxXQUFXLEdBQUcsS0FBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsY0FBYyxDQUFDLENBQUM7UUFFekQsS0FBSSxDQUFDLGFBQWEsQ0FBQyxjQUFjLEdBQUcsS0FBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUM7UUFFbkUsS0FBSSxDQUFDLGFBQWEsQ0FBQyxlQUFlLEdBQUcsS0FBSSxDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUM7UUFJdEUsS0FBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxVQUFDLE1BQU07WUFDeEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMs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LEVBQUUsRUFBRSxjQUFjLEVBQUUsa0JBQWtCLEVBQUU7WUFDL0MsT0FBTyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLENBQUM7U0FDekMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUdMLGdCQUFDO0FBQUQsQ0FBQyxBQXJVRCxDQUErQix1QkFBVSxHQXFVeEM7QUFyVVksOEJBQVMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYnNlcnZhYmxlLCBmcm9tT2JqZWN0IH0gZnJvbSAnZGF0YS9vYnNlcnZhYmxlJztcbmltcG9ydCB7IFBhZ2UgfSBmcm9tICd1aS9wYWdlJztcbmltcG9ydCAqIGFzIGFwcCBmcm9tIFwidG5zLWNvcmUtbW9kdWxlcy9hcHBsaWNhdGlvblwiO1xuaW1wb3J0IHsgTG9jYWxWaWRlbywgVmlkZW9BY3Rpdml0eSwgUmVtb3RlVmlkZW8gfSBmcm9tICduYXRpdmVzY3JpcHQtdHdpbGlvLXZpZGVvJztcbmltcG9ydCAqIGFzIGRpYWxvZ3MgZnJvbSBcInVpL2RpYWxvZ3NcIjtcbmltcG9ydCB7IFN0YWNrTGF5b3V0IH0gZnJvbSAndG5zLWNvcmUtbW9kdWxlcy91aS9sYXlvdXRzL3N0YWNrLWxheW91dC9zdGFjay1sYXlvdXQnO1xuaW1wb3J0IHsgR3JpZExheW91dCwgSXRlbVNwZWMgfSBmcm9tICd1aS9sYXlvdXRzL2dyaWQtbGF5b3V0JztcblxuY29uc3QgaHR0cCA9IHJlcXVpcmUoXCJodHRwXCIpO1xuY29uc3QgcGVybWlzc2lvbnMgPSByZXF1aXJlKCduYXRpdmVzY3JpcHQtcGVybWlzc2lvbnMnKTtcbmNvbnN0IHRpbWVyID0gcmVxdWlyZShcInRpbWVyXCIpO1xuXG5cblxuZXhwb3J0IGNsYXNzIFZpZGVvQ2hhdCBleHRlbmRzIE9ic2VydmFibGUge1xuICAgIFxuICAgIHB1YmxpYyBjb250YWluZXI6IGFueTtcbiAgICBwdWJsaWMgbG9jYWxWaWRlbzogYW55O1xuICAgIHB1YmxpYyByZW1vdGVWaWRlbzogYW55O1xuICAgIHB1YmxpYyBhY2Nlc3NUb2tlbjogc3RyaW5nO1xuICAgIHB1YmxpYyByb29tOiBzdHJpbmc7XG4gICAgcHVibGljIG5hbWU6IHN0cmluZztcbiAgICBwdWJsaWMgZXJyb3I6IHN0cmluZztcbiAgICBwdWJsaWMgdmlkZW9BY3Rpdml0eTogVmlkZW9BY3Rpdml0eTtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcGFnZTogUGFnZSkge1xuICAgICAgICBzdXBlcigpO1xuXG4gICAgICAgIHRoaXMuY29udGFpbmVyID0gPFN0YWNrTGF5b3V0PnRoaXMucGFnZS5nZXRWaWV3QnlJZCgnY29udGFpbmVyJyk7XG5cbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5ID0gbmV3IFZpZGVvQWN0aXZpdHkoKTtcblxuICAgICAgICB0aGlzLmxvY2FsVmlkZW8gPSB0aGlzLnBhZ2UuZ2V0Vmlld0J5SWQoJ2xvY2FsLXZpZGVvJyk7XG5cbiAgICAgICAgdGhpcy5yZW1vdGVWaWRlbyA9IHRoaXMucGFnZS5nZXRWaWV3QnlJZCgncmVtb3RlLXZpZGVvJyk7XG5cbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LmxvY2FsVmlkZW9WaWV3ID0gdGhpcy5sb2NhbFZpZGVvLmxvY2FsVmlkZW9WaWV3O1xuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5yZW1vdGVWaWRlb1ZpZXcgPSB0aGlzLnJlbW90ZVZpZGVvLnJlbW90ZVZpZGVvVmlldztcblxuICAgICAgICAvLyB0aGlzLmFkZF92aWRlb192aWV3cygpO1xuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5ldmVudC5vbignZXJyb3InLCAocmVhc29uKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnYmlnIGVycm9yJyk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhyZWFzb24ub2JqZWN0WydyZWFzb24nXSk7XG4gICAgICAgICAgICB0aGlzLnNldChcImVycm9yXCIsIHJlYXNvbi5vYmplY3RbJ3JlYXNvbiddKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHJlYXNvbi5vYmplY3RbJ3JlYXNvbiddKSk7XG4gICAgICAgIH0pO1xuXG5cbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LmV2ZW50Lm9uKCdkaWRDb25uZWN0VG9Sb29tJywgKHIpID0+IHtcbiAgICAgICAgICAgIC8vIGlmIChyLm9iamVjdFsnY291bnQnXSA8IDEpIHJldHVybjtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiZGlkQ29ubmVjdFRvUm9vbVwiKTtcbiAgICAgICAgICAgIC8vIHRoaXMudG9nZ2xlX2xvY2FsX3ZpZGVvX3NpemUoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LmV2ZW50Lm9uKCdkaWRGYWlsVG9Db25uZWN0V2l0aEVycm9yJywgKHIpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiZGlkRmFpbFRvQ29ubmVjdFdpdGhFcnJvclwiKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LmV2ZW50Lm9uKCdwYXJ0aWNpcGFudERpZENvbm5lY3QnLCAocikgPT4ge1xuICAgICAgICAgICAgLy8gaWYgKHIub2JqZWN0Wydjb3VudCddIDwgMSkgcmV0dXJuO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJwYXJ0aWNpcGFudERpZENvbm5lY3RcIik7XG4gICAgICAgICAgICAvLyB0aGlzLnRvZ2dsZV9sb2NhbF92aWRlb19zaXplKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5ldmVudC5vbigncGFydGljaXBhbnREaWREaXNjb25uZWN0JywgKHIpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwicGFydGljaXBhbnREaWREaXNjb25uZWN0XCIpO1xuICAgICAgICAgICAgLy8gdGhpcy50b2dnbGVfbG9jYWxfdmlkZW9fc2l6ZSgpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZXZlbnQub24oJ3BhcnRpY2lwYW50VW5wdWJsaXNoZWRBdWRpb1RyYWNrJywgKHIpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwicGFydGljaXBhbnRVbnB1Ymxpc2hlZEF1ZGlvVHJhY2tcIik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5ldmVudC5vbigncGFydGljaXBhbnRQdWJsaXNoZWRWaWRlb1RyYWNrJywgKHIpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwicGFydGljaXBhbnRQdWJsaXNoZWRWaWRlb1RyYWNrXCIpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZXZlbnQub24oJ3BhcnRpY2lwYW50VW5wdWJsaXNoZWRWaWRlb1RyYWNrJywgKHIpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwicGFydGljaXBhbnRVbnB1Ymxpc2hlZFZpZGVvVHJhY2tcIik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5ldmVudC5vbignb25BdWRpb1RyYWNrU3Vic2NyaWJlZCcsIChyKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIm9uQXVkaW9UcmFja1N1YnNjcmliZWRcIik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5ldmVudC5vbignb25BdWRpb1RyYWNrVW5zdWJzY3JpYmVkJywgKHIpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwib25BdWRpb1RyYWNrVW5zdWJzY3JpYmVkXCIpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZXZlbnQub24oJ29uVmlkZW9UcmFja1N1YnNjcmliZWQnLCAocikgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJvblZpZGVvVHJhY2tTdWJzY3JpYmVkXCIpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZXZlbnQub24oJ29uVmlkZW9UcmFja1Vuc3Vic2NyaWJlZCcsIChyKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIm9uVmlkZW9UcmFja1Vuc3Vic2NyaWJlZCAwMFwiKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LmV2ZW50Lm9uKCdwYXJ0aWNpcGFudERpc2FibGVkVmlkZW9UcmFjaycsIChyKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcInBhcnRpY2lwYW50RGlzYWJsZWRWaWRlb1RyYWNrXCIpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZXZlbnQub24oJ3BhcnRpY2lwYW50RW5hYmxlZFZpZGVvVHJhY2snLCAocikgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJwYXJ0aWNpcGFudEVuYWJsZWRWaWRlb1RyYWNrXCIpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZXZlbnQub24oJ3BhcnRpY2lwYW50RGlzYWJsZWRBdWRpb1RyYWNrJywgKHIpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwicGFydGljaXBhbnREaXNhYmxlZEF1ZGlvVHJhY2tcIik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5ldmVudC5vbigncGFydGljaXBhbnRFbmFibGVkQXVkaW9UcmFjaycsIChyKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcInBhcnRpY2lwYW50RW5hYmxlZEF1ZGlvVHJhY2tcIik7XG4gICAgICAgIH0pO1xuXG5cbiAgICAgICAgdGhpcy5nZXRfcGVybWlzc2lvbnMoKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIGkgZmluZCB0aGUgc2V0dGltZW91dCBhbGxvd3MgZm9yIGEgc21vb3RoZXIgbG9hZCBpZiB5b3UncmUgbG9va2luZyBmb3IgdGhlIHByZXZpZXcgdG8gYmVnaW4gaW1tZWRpYXRlbHlcbiAgICAgICAgICAgICAgICB2YXIgdCA9IHRpbWVyLnNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuc3RhcnRQcmV2aWV3KCk7XG4gICAgICAgICAgICAgICAgICAgIHRpbWVyLmNsZWFyVGltZW91dCh0KTtcbiAgICAgICAgICAgICAgICB9LCAxMjAwKVxuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgdG9nZ2xlX2xvY2FsX3ZpZGVvX3NpemUoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmxvY2FsVmlkZW8uY2xhc3NOYW1lID09PSAnbGFyZ2UnKSB7XG4gICAgICAgICAgICB0aGlzLmxvY2FsVmlkZW8uY2xhc3NOYW1lID0gJ3NtYWxsJztcbiAgICAgICAgICAgIEdyaWRMYXlvdXQuc2V0Q29sdW1uKHRoaXMubG9jYWxWaWRlbywgMSk7XG4gICAgICAgICAgICBHcmlkTGF5b3V0LnNldFJvdyh0aGlzLmxvY2FsVmlkZW8sIDApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5sb2NhbFZpZGVvLmNsYXNzTmFtZSA9ICdsYXJnZSc7XG4gICAgICAgICAgICBHcmlkTGF5b3V0LnNldENvbHVtbih0aGlzLmxvY2FsVmlkZW8sIDApO1xuICAgICAgICAgICAgR3JpZExheW91dC5zZXRDb2x1bW5TcGFuKHRoaXMubG9jYWxWaWRlbywgMik7XG4gICAgICAgICAgICBHcmlkTGF5b3V0LnNldFJvd1NwYW4odGhpcy5sb2NhbFZpZGVvLCAyKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFkZF92aWRlb192aWV3cygpOiB2b2lkIHtcbiAgICAgICAgLy8gdGhpcy5sb2NhbFZpZGVvLmlkID0gJ2xvY2FsLXZpZGVvJztcbiAgICAgICAgdGhpcy5sb2NhbFZpZGVvLmNsYXNzTmFtZSA9ICdsYXJnZSc7XG4gICAgICAgIHRoaXMucmVtb3RlVmlkZW8uaWQgPSAncmVtb3RlLXZpZGVvJztcblxuICAgICAgICB0aGlzLmxvY2FsVmlkZW8ub24oJ3RhcCcsIHRoaXMudG9nZ2xlX2xvY2FsX3ZpZGVvX3NpemUuYmluZCh0aGlzKSk7XG5cbiAgICAgICAgR3JpZExheW91dC5zZXRDb2x1bW5TcGFuKHRoaXMucmVtb3RlVmlkZW8sIDIpO1xuICAgICAgICBHcmlkTGF5b3V0LnNldFJvd1NwYW4odGhpcy5yZW1vdGVWaWRlbywgMik7XG4gICAgICAgIEdyaWRMYXlvdXQuc2V0Um93KHRoaXMucmVtb3RlVmlkZW8sIDApO1xuICAgICAgICBHcmlkTGF5b3V0LnNldENvbHVtblNwYW4odGhpcy5sb2NhbFZpZGVvLCAyKTtcbiAgICAgICAgR3JpZExheW91dC5zZXRSb3dTcGFuKHRoaXMubG9jYWxWaWRlbywgMik7XG4gICAgICAgIEdyaWRMYXlvdXQuc2V0Um93KHRoaXMubG9jYWxWaWRlbywgMCk7XG4gICAgICAgIHRoaXMuY29udGFpbmVyLmluc2VydENoaWxkKHRoaXMucmVtb3RlVmlkZW8sIDApO1xuICAgICAgICB0aGlzLmNvbnRhaW5lci5pbnNlcnRDaGlsZCh0aGlzLmxvY2FsVmlkZW8sIDApO1xuICAgIH1cblxuXG5cbiAgICBjaGVja19wZXJtaXNzaW9ucygpOiBib29sZWFuIHtcbiAgICAgICAgdmFyIGF1ZGlvLCBjYW1lcmE7XG5cbiAgICAgICAgaWYgKGFwcC5hbmRyb2lkKSB7XG4gICAgICAgICAgICBhdWRpbyA9IHBlcm1pc3Npb25zLmhhc1Blcm1pc3Npb24oXCJhbmRyb2lkLnBlcm1pc3Npb24uUkVDT1JEX0FVRElPXCIpXG4gICAgICAgICAgICBjYW1lcmEgPSBwZXJtaXNzaW9ucy5oYXNQZXJtaXNzaW9uKFwiYW5kcm9pZC5wZXJtaXNzaW9uLkNBTUVSQVwiKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY2FtZXJhID0gQVZDYXB0dXJlRGV2aWNlLmF1dGhvcml6YXRpb25TdGF0dXNGb3JNZWRpYVR5cGUoQVZNZWRpYVR5cGVWaWRlbyk7XG4gICAgICAgICAgICBhdWRpbyA9IEFWQ2FwdHVyZURldmljZS5hdXRob3JpemF0aW9uU3RhdHVzRm9yTWVkaWFUeXBlKEFWTWVkaWFUeXBlQXVkaW8pO1xuICAgICAgICAgICAgaWYgKGNhbWVyYSA8IDMpIGNhbWVyYSA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKGF1ZGlvIDwgMykgYXVkaW8gPSBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghYXVkaW8gfHwgIWNhbWVyYSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICBlbHNlIHJldHVybiB0cnVlO1xuXG4gICAgfVxuXG4gICAgZ2V0X3Blcm1pc3Npb25zKCk6IFByb21pc2U8YW55PiB7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblxuICAgICAgICAgICAgdmFyIGhhc19wZXJtaXNzaW9ucyA9IHRoaXMuY2hlY2tfcGVybWlzc2lvbnMoKTtcblxuICAgICAgICAgICAgaWYgKGhhc19wZXJtaXNzaW9ucykge1xuICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChhcHAuYW5kcm9pZCkge1xuICAgICAgICAgICAgICAgIHBlcm1pc3Npb25zLnJlcXVlc3RQZXJtaXNzaW9ucyhbXG4gICAgICAgICAgICAgICAgICAgIFwiYW5kcm9pZC5wZXJtaXNzaW9uLlJFQ09SRF9BVURJT1wiLFxuICAgICAgICAgICAgICAgICAgICBcImFuZHJvaWQucGVybWlzc2lvbi5DQU1FUkFcIlxuICAgICAgICAgICAgICAgIF0sIFwiSSBuZWVkIHRoZXNlIHBlcm1pc3Npb25zIGJlY2F1c2UgSSdtIGNvb2xcIilcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmRpcihyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKChlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmRpcihlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVWggb2gsIG5vIHBlcm1pc3Npb25zIC0gcGxhbiBCIHRpbWUhXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGhhc19wZXJtaXNzaW9ucyA9IHRoaXMuY2hlY2tfcGVybWlzc2lvbnMoKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFoYXNfcGVybWlzc2lvbnMpIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpYWxvZ3MuYWxlcnQoXCJ3aXRob3V0IG1pYyBhbmQgY2FtZXJhIHBlcm1pc3Npb25zIFxcbiB5b3UgY2Fubm90IGNvbm5lY3QuIFxcbiBwbGVhc2UgYWxsb3cgcGVybWlzc2lvbnMgaW4gc2V0dGluZ3MgYW5kIHRyeSBhZ2Fpbi5cIikudGhlbigoKSA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgICAgIFByb21pc2UuYWxsKFt0aGlzLmlvc19taWNfcGVybWlzc2lvbigpLCB0aGlzLmlvc19jYW1lcmFfcGVybWlzc2lvbigpXSlcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4odmFsdWVzID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHZhbHVlcykpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9LCByZWFzb24gPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkocmVhc29uKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldCgnZXJyb3InLCByZWFzb24pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBkaWFsb2dzLmFsZXJ0KFwid2l0aG91dCBtaWMgYW5kIGNhbWVyYSBwZXJtaXNzaW9ucyBcXG4geW91IGNhbm5vdCBjb25uZWN0LiBcXG4gcGxlYXNlIGFsbG93IHBlcm1pc3Npb25zIGluIHNldHRpbmdzIGFuZCB0cnkgYWdhaW4uXCIpLnRoZW4oKCkgPT4ge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgVUlBcHBsaWNhdGlvbi5zaGFyZWRBcHBsaWNhdGlvbi5vcGVuVVJMKE5TVVJMLlVSTFdpdGhTdHJpbmcoVUlBcHBsaWNhdGlvbk9wZW5TZXR0aW5nc1VSTFN0cmluZykpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KClcblxuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0pXG5cbiAgICB9XG5cbiAgICBpb3NfbWljX3Blcm1pc3Npb24oKTogUHJvbWlzZTxhbnk+IHtcblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXG4gICAgICAgICAgICB2YXIgaGFzX2Fza2VkID0gQVZDYXB0dXJlRGV2aWNlLmF1dGhvcml6YXRpb25TdGF0dXNGb3JNZWRpYVR5cGUoQVZNZWRpYVR5cGVBdWRpbyk7XG5cbiAgICAgICAgICAgIGlmIChoYXNfYXNrZWQgPT09IDIpIHtcbiAgICAgICAgICAgICAgICByZWplY3QoJ21pYyBwZXJtaXNzaW9uIGRlbmllZCcpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgQVZBdWRpb1Nlc3Npb24uc2hhcmVkSW5zdGFuY2UoKS5yZXF1ZXN0UmVjb3JkUGVybWlzc2lvbigoYm9vbCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChib29sID09PSB0cnVlKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoYm9vbCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmVqZWN0KCdtaWMgcGVybWlzc2lvbiBkZW5pZWQnKTtcblxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfSlcblxuICAgIH1cblxuICAgIGlvc19jYW1lcmFfcGVybWlzc2lvbigpOiBQcm9taXNlPGFueT4ge1xuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cbiAgICAgICAgICAgIHZhciBoYXNfYXNrZWQgPSBBVkNhcHR1cmVEZXZpY2UuYXV0aG9yaXphdGlvblN0YXR1c0Zvck1lZGlhVHlwZShBVk1lZGlhVHlwZVZpZGVvKTtcblxuICAgICAgICAgICAgaWYgKGhhc19hc2tlZCA9PT0gMikge1xuICAgICAgICAgICAgICAgIHJlamVjdCgnY2FtZXJhIHBlcm1pc3Npb24gZGVuaWVkJyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBBVkNhcHR1cmVEZXZpY2UucmVxdWVzdEFjY2Vzc0Zvck1lZGlhVHlwZUNvbXBsZXRpb25IYW5kbGVyKEFWTWVkaWFUeXBlVmlkZW8sIChib29sKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGJvb2wgPT09IHRydWUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShib29sKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZWplY3QoJ2NhbWVyYSBwZXJtaXNzaW9uIGRlbmllZCcpO1xuXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9KVxuICAgIH1cblxuXG4gICAgcHVibGljIGRpc2Nvbm5lY3QoKSB7XG5cbiAgICAgICAgaWYgKHRoaXMudmlkZW9BY3Rpdml0eS5yb29tKSB7XG5cbiAgICAgICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5kaXNjb25uZWN0KCk7XG5cbiAgICAgICAgfVxuXG4gICAgfVxuXG5cbiAgICBwdWJsaWMgdG9nZ2xlX2xvY2FsX2F1ZGlvKCkge1xuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS50b2dnbGVfbG9jYWxfYXVkaW8oKTtcblxuICAgIH1cblxuXG4gICAgcHVibGljIHRvZ2dsZV9sb2NhbF92aWRlbygpIHtcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkudG9nZ2xlX2xvY2FsX3ZpZGVvKCk7XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgY29ubmVjdF90b19yb29tKCk6IHZvaWQge1xuICAgICAgICBpZiAoIXRoaXMuZ2V0KCduYW1lJykgfHwgIXRoaXMuZ2V0KCdyb29tJykgfHwgdGhpcy5nZXQoJ25hbWUnKS5sZW5ndGggPCAxIHx8IHRoaXMuZ2V0KCdyb29tJykubGVuZ3RoIDwgMSlcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnNldCgnZXJyb3InLCBcIk1pc3NpbmcgSW5mby5cIik7XG4gICAgICAgIGVsc2UgdGhpcy5zZXQoJ2Vycm9yJywgXCJcIik7XG4gICAgICAgIHRoaXMuZ2V0X3Rva2VuKClcbiAgICAgICAgICAgIC50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHJlc3VsdC5jb250ZW50LnRvSlNPTigpO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgaWYgKHJlc3VsdFsnbWVzc2FnZSddKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0KCdlcnJvcicsIHJlc3VsdFsnbWVzc2FnZSddKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuc2V0X2FjY2Vzc190b2tlbihyZXN1bHRbJ3R3aWxpb1Rva2VuJ10pO1xuICAgICAgICAgICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5jb25uZWN0X3RvX3Jvb20odGhpcy5nZXQoJ3Jvb20nKSwge3ZpZGVvOiB0cnVlLCBhdWRpbzogdHJ1ZX0pO1xuICAgICAgICAgICAgfSwgZSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZXQoJ2Vycm9yJywgZSk7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cblxuICAgIHB1YmxpYyBnZXRfdG9rZW4oKTogUHJvbWlzZTxhbnk+IHtcbiAgICAgICAgbGV0IG5hbWUgPSB0aGlzLmdldCgnbmFtZScpXG4gICAgICAgIHJldHVybiBodHRwLnJlcXVlc3Qoe1xuICAgICAgICAgICAgdXJsOiAnaHR0cHM6Ly82NTFiYTQyNS5uZ3Jvay5pby90d2lsaW9Ub2tlbicsXG4gICAgICAgICAgICBtZXRob2Q6IFwiUE9TVFwiLFxuICAgICAgICAgICAgaGVhZGVyczogeyBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIiB9LFxuICAgICAgICAgICAgY29udGVudDogSlNPTi5zdHJpbmdpZnkoeyB1aWQ6IG5hbWUgfSlcbiAgICAgICAgfSk7XG4gICAgfVxuXG5cbn0iXX0=