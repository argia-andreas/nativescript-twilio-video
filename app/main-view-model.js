"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var observable_1 = require("data/observable");
var app = require("tns-core-modules/application");
var nativescript_twilio_video_1 = require("nativescript-twilio-video");
var dialogs = require("ui/dialogs");
var grid_layout_1 = require("ui/layouts/grid-layout");
var http = require("http");
var permissions = require('nativescript-permissions');
var timer = require("timer");
var VideoChat = (function (_super) {
    __extends(VideoChat, _super);
    function VideoChat(page) {
        var _this = _super.call(this) || this;
        _this.page = page;
        _this.container = _this.page.getViewById('container');
        _this.videoActivity = new nativescript_twilio_video_1.VideoActivity();
        _this.localVideo = new nativescript_twilio_video_1.LocalVideo();
        _this.remoteVideo = new nativescript_twilio_video_1.RemoteVideo();
        _this.videoActivity.localVideoView = _this.localVideo.localVideoView;
        _this.videoActivity.remoteVideoView = _this.remoteVideo.remoteVideoView;
        _this.add_video_views();
        _this.videoActivity.event.on('error', function (reason) {
            console.log('big error');
            console.log(reason.object['reason']);
            _this.set("error", reason.object['reason']);
            console.log(JSON.stringify(reason.object['reason']));
        });
        _this.videoActivity.event.on('didConnectToRoom', function (r) {
            console.log("didConnectToRoom");
            _this.toggle_local_video_size();
        });
        _this.videoActivity.event.on('didFailToConnectWithError', function (r) {
            console.log("didFailToConnectWithError");
        });
        _this.videoActivity.event.on('participantDidConnect', function (r) {
            if (r.object['count'] < 1)
                return;
            console.log("participantDidConnect");
            _this.toggle_local_video_size();
        });
        _this.videoActivity.event.on('participantDidDisconnect', function (r) {
            console.log("participantDidDisconnect");
            _this.toggle_local_video_size();
        });
        _this.videoActivity.event.on('participantUnpublishedAudioTrack', function (r) {
            console.log("participantUnpublishedAudioTrack");
        });
        _this.videoActivity.event.on('participantPublishedVideoTrack', function (r) {
            console.log("participantPublishedVideoTrack");
        });
        _this.videoActivity.event.on('participantUnpublishedVideoTrack', function (r) {
            console.log("participantUnpublishedVideoTrack");
        });
        _this.videoActivity.event.on('onAudioTrackSubscribed', function (r) {
            console.log("onAudioTrackSubscribed");
        });
        _this.videoActivity.event.on('onAudioTrackUnsubscribed', function (r) {
            console.log("onAudioTrackUnsubscribed");
        });
        _this.videoActivity.event.on('onVideoTrackSubscribed', function (r) {
            console.log("onVideoTrackSubscribed");
        });
        _this.videoActivity.event.on('onVideoTrackUnsubscribed', function (r) {
            console.log("onVideoTrackUnsubscribed 00");
        });
        _this.videoActivity.event.on('participantDisabledVideoTrack', function (r) {
            console.log("participantDisabledVideoTrack");
        });
        _this.videoActivity.event.on('participantEnabledVideoTrack', function (r) {
            console.log("participantEnabledVideoTrack");
        });
        _this.videoActivity.event.on('participantDisabledAudioTrack', function (r) {
            console.log("participantDisabledAudioTrack");
        });
        _this.videoActivity.event.on('participantEnabledAudioTrack', function (r) {
            console.log("participantEnabledAudioTrack");
        });
        _this.get_permissions()
            .then(function () {
            var t = timer.setTimeout(function () {
                _this.videoActivity.startPreview();
                timer.clearTimeout(t);
            }, 1200);
        });
        return _this;
    }
    VideoChat.prototype.toggle_local_video_size = function () {
        if (this.localVideo.className === 'large') {
            this.localVideo.className = 'small';
            grid_layout_1.GridLayout.setColumn(this.localVideo, 1);
            grid_layout_1.GridLayout.setRow(this.localVideo, 0);
        }
        else {
            this.localVideo.className = 'large';
            grid_layout_1.GridLayout.setColumn(this.localVideo, 0);
            grid_layout_1.GridLayout.setColumnSpan(this.localVideo, 2);
            grid_layout_1.GridLayout.setRowSpan(this.localVideo, 2);
        }
    };
    VideoChat.prototype.add_video_views = function () {
        this.localVideo.className = 'large';
        this.remoteVideo.id = 'remote-video';
        this.localVideo.on('tap', this.toggle_local_video_size.bind(this));
        grid_layout_1.GridLayout.setColumnSpan(this.remoteVideo, 2);
        grid_layout_1.GridLayout.setRowSpan(this.remoteVideo, 2);
        grid_layout_1.GridLayout.setRow(this.remoteVideo, 0);
        grid_layout_1.GridLayout.setColumnSpan(this.localVideo, 2);
        grid_layout_1.GridLayout.setRowSpan(this.localVideo, 2);
        grid_layout_1.GridLayout.setRow(this.localVideo, 0);
        this.container.insertChild(this.remoteVideo, 0);
        this.container.insertChild(this.localVideo, 0);
    };
    VideoChat.prototype.check_permissions = function () {
        var audio, camera;
        if (app.android) {
            audio = permissions.hasPermission("android.permission.RECORD_AUDIO");
            camera = permissions.hasPermission("android.permission.CAMERA");
        }
        else {
            camera = AVCaptureDevice.authorizationStatusForMediaType(AVMediaTypeVideo);
            audio = AVCaptureDevice.authorizationStatusForMediaType(AVMediaTypeAudio);
            if (camera < 3)
                camera = false;
            if (audio < 3)
                audio = false;
        }
        if (!audio || !camera)
            return false;
        else
            return true;
    };
    VideoChat.prototype.get_permissions = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            var has_permissions = _this.check_permissions();
            if (has_permissions) {
                resolve();
                return;
            }
            if (app.android) {
                permissions.requestPermissions([
                    "android.permission.RECORD_AUDIO",
                    "android.permission.CAMERA"
                ], "I need these permissions because I'm cool")
                    .then(function (response) {
                    console.dir(response);
                    resolve(response);
                })
                    .catch(function (e) {
                    console.dir(e);
                    console.log("Uh oh, no permissions - plan B time!");
                    var has_permissions = _this.check_permissions();
                    if (!has_permissions) {
                        dialogs.alert("without mic and camera permissions \n you cannot connect. \n please allow permissions in settings and try again.").then(function () {
                        });
                    }
                });
            }
            else {
                Promise.all([_this.ios_mic_permission(), _this.ios_camera_permission()])
                    .then(function (values) {
                    console.log(JSON.stringify(values));
                    resolve();
                }, function (reason) {
                    console.log(JSON.stringify(reason));
                    _this.set('error', reason);
                    dialogs.alert("without mic and camera permissions \n you cannot connect. \n please allow permissions in settings and try again.").then(function () {
                        UIApplication.sharedApplication.openURL(NSURL.URLWithString(UIApplicationOpenSettingsURLString));
                    });
                    reject();
                });
            }
        });
    };
    VideoChat.prototype.ios_mic_permission = function () {
        return new Promise(function (resolve, reject) {
            var has_asked = AVCaptureDevice.authorizationStatusForMediaType(AVMediaTypeAudio);
            if (has_asked === 2) {
                reject('mic permission denied');
                return;
            }
            AVAudioSession.sharedInstance().requestRecordPermission(function (bool) {
                if (bool === true) {
                    resolve(bool);
                    return;
                }
                reject('mic permission denied');
            });
        });
    };
    VideoChat.prototype.ios_camera_permission = function () {
        return new Promise(function (resolve, reject) {
            var has_asked = AVCaptureDevice.authorizationStatusForMediaType(AVMediaTypeVideo);
            if (has_asked === 2) {
                reject('camera permission denied');
                return;
            }
            AVCaptureDevice.requestAccessForMediaTypeCompletionHandler(AVMediaTypeVideo, function (bool) {
                if (bool === true) {
                    resolve(bool);
                    return;
                }
                reject('camera permission denied');
            });
        });
    };
    VideoChat.prototype.disconnect = function () {
        if (this.videoActivity.room) {
            this.videoActivity.disconnect();
        }
    };
    VideoChat.prototype.toggle_local_audio = function () {
        this.videoActivity.toggle_local_audio();
    };
    VideoChat.prototype.toggle_local_video = function () {
        this.videoActivity.toggle_local_video();
    };
    VideoChat.prototype.connect_to_room = function () {
        var _this = this;
        if (!this.get('name') || !this.get('room') || this.get('name').length < 1 || this.get('room').length < 1)
            return this.set('error', "Missing Info.");
        else
            this.set('error', "");
        this.get_token()
            .then(function (result) {
            var result = result.content.toJSON();
            console.log(result);
            _this.videoActivity.set_access_token(result['token']);
            _this.videoActivity.connect_to_room(_this.get('room'), { video: true, audio: true });
        }, function (e) {
            _this.set('error', e);
        });
    };
    VideoChat.prototype.get_token = function () {
        var name = this.get('name');
        return http.request({
            url: 'https://7720ba31.ngrok.io/getToken',
            method: "POST",
            headers: { "Content-Type": "application/json" },
            content: JSON.stringify({ uid: name })
        });
    };
    return VideoChat;
}(observable_1.Observable));
exports.VideoChat = VideoChat;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi12aWV3LW1vZGVsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibWFpbi12aWV3LW1vZGVsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsOENBQXlEO0FBRXpELGtEQUFvRDtBQUNwRCx1RUFBbUY7QUFDbkYsb0NBQXNDO0FBRXRDLHNEQUE4RDtBQUU5RCxJQUFNLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDN0IsSUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLDBCQUEwQixDQUFDLENBQUM7QUFDeEQsSUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBSS9CO0lBQStCLDZCQUFVO0lBV3JDLG1CQUFvQixJQUFVO1FBQTlCLFlBQ0ksaUJBQU8sU0FrR1Y7UUFuR21CLFVBQUksR0FBSixJQUFJLENBQU07UUFHMUIsS0FBSSxDQUFDLFNBQVMsR0FBZ0IsS0FBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFakUsS0FBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLHlDQUFhLEVBQUUsQ0FBQztRQUV6QyxLQUFJLENBQUMsVUFBVSxHQUFHLElBQUksc0NBQVUsRUFBRSxDQUFDO1FBRW5DLEtBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSx1Q0FBVyxFQUFFLENBQUM7UUFFckMsS0FBSSxDQUFDLGFBQWEsQ0FBQyxjQUFjLEdBQUcsS0FBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUM7UUFFbkUsS0FBSSxDQUFDLGFBQWEsQ0FBQyxlQUFlLEdBQUcsS0FBSSxDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUM7UUFFdEUsS0FBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBRXZCLEtBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsVUFBQyxNQUFNO1lBQ3hDLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDekIsT0FBTyxD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QUFNO1lBQ2QsT0FBTyxFQUFFLEVBQUUsY0FBYyxFQUFFLGtCQUFrQixFQUFFO1lBQy9DLE9BQU8sRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxDQUFDO1NBQ3pDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFHTCxnQkFBQztBQUFELENBQUMsQUFqVUQsQ0FBK0IsdUJBQVUsR0FpVXhDO0FBalVZLDhCQUFTIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JzZXJ2YWJsZSwgZnJvbU9iamVjdCB9IGZyb20gJ2RhdGEvb2JzZXJ2YWJsZSc7XG5pbXBvcnQgeyBQYWdlIH0gZnJvbSAndWkvcGFnZSc7XG5pbXBvcnQgKiBhcyBhcHAgZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvYXBwbGljYXRpb25cIjtcbmltcG9ydCB7IExvY2FsVmlkZW8sIFZpZGVvQWN0aXZpdHksIFJlbW90ZVZpZGVvIH0gZnJvbSAnbmF0aXZlc2NyaXB0LXR3aWxpby12aWRlbyc7XG5pbXBvcnQgKiBhcyBkaWFsb2dzIGZyb20gXCJ1aS9kaWFsb2dzXCI7XG5pbXBvcnQgeyBTdGFja0xheW91dCB9IGZyb20gJ3Rucy1jb3JlLW1vZHVsZXMvdWkvbGF5b3V0cy9zdGFjay1sYXlvdXQvc3RhY2stbGF5b3V0JztcbmltcG9ydCB7IEdyaWRMYXlvdXQsIEl0ZW1TcGVjIH0gZnJvbSAndWkvbGF5b3V0cy9ncmlkLWxheW91dCc7XG5cbmNvbnN0IGh0dHAgPSByZXF1aXJlKFwiaHR0cFwiKTtcbmNvbnN0IHBlcm1pc3Npb25zID0gcmVxdWlyZSgnbmF0aXZlc2NyaXB0LXBlcm1pc3Npb25zJyk7XG5jb25zdCB0aW1lciA9IHJlcXVpcmUoXCJ0aW1lclwiKTtcblxuXG5cbmV4cG9ydCBjbGFzcyBWaWRlb0NoYXQgZXh0ZW5kcyBPYnNlcnZhYmxlIHtcbiAgICBcbiAgICBwdWJsaWMgY29udGFpbmVyOiBhbnk7XG4gICAgcHVibGljIGxvY2FsVmlkZW86IExvY2FsVmlkZW87XG4gICAgcHVibGljIHJlbW90ZVZpZGVvOiBSZW1vdGVWaWRlbztcbiAgICBwdWJsaWMgYWNjZXNzVG9rZW46IHN0cmluZztcbiAgICBwdWJsaWMgcm9vbTogc3RyaW5nO1xuICAgIHB1YmxpYyBuYW1lOiBzdHJpbmc7XG4gICAgcHVibGljIGVycm9yOiBzdHJpbmc7XG4gICAgcHVibGljIHZpZGVvQWN0aXZpdHk6IFZpZGVvQWN0aXZpdHk7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIHBhZ2U6IFBhZ2UpIHtcbiAgICAgICAgc3VwZXIoKTtcblxuICAgICAgICB0aGlzLmNvbnRhaW5lciA9IDxTdGFja0xheW91dD50aGlzLnBhZ2UuZ2V0Vmlld0J5SWQoJ2NvbnRhaW5lcicpO1xuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eSA9IG5ldyBWaWRlb0FjdGl2aXR5KCk7XG5cbiAgICAgICAgdGhpcy5sb2NhbFZpZGVvID0gbmV3IExvY2FsVmlkZW8oKTtcblxuICAgICAgICB0aGlzLnJlbW90ZVZpZGVvID0gbmV3IFJlbW90ZVZpZGVvKCk7XG5cbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LmxvY2FsVmlkZW9WaWV3ID0gdGhpcy5sb2NhbFZpZGVvLmxvY2FsVmlkZW9WaWV3O1xuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5yZW1vdGVWaWRlb1ZpZXcgPSB0aGlzLnJlbW90ZVZpZGVvLnJlbW90ZVZpZGVvVmlldztcblxuICAgICAgICB0aGlzLmFkZF92aWRlb192aWV3cygpO1xuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5ldmVudC5vbignZXJyb3InLCAocmVhc29uKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnYmlnIGVycm9yJyk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhyZWFzb24ub2JqZWN0WydyZWFzb24nXSk7XG4gICAgICAgICAgICB0aGlzLnNldChcImVycm9yXCIsIHJlYXNvbi5vYmplY3RbJ3JlYXNvbiddKTtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHJlYXNvbi5vYmplY3RbJ3JlYXNvbiddKSk7XG4gICAgICAgIH0pO1xuXG5cbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LmV2ZW50Lm9uKCdkaWRDb25uZWN0VG9Sb29tJywgKHIpID0+IHtcbiAgICAgICAgICAgIC8vIGlmIChyLm9iamVjdFsnY291bnQnXSA8IDEpIHJldHVybjtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiZGlkQ29ubmVjdFRvUm9vbVwiKTtcbiAgICAgICAgICAgIHRoaXMudG9nZ2xlX2xvY2FsX3ZpZGVvX3NpemUoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LmV2ZW50Lm9uKCdkaWRGYWlsVG9Db25uZWN0V2l0aEVycm9yJywgKHIpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiZGlkRmFpbFRvQ29ubmVjdFdpdGhFcnJvclwiKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LmV2ZW50Lm9uKCdwYXJ0aWNpcGFudERpZENvbm5lY3QnLCAocikgPT4ge1xuICAgICAgICAgICAgaWYgKHIub2JqZWN0Wydjb3VudCddIDwgMSkgcmV0dXJuO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJwYXJ0aWNpcGFudERpZENvbm5lY3RcIik7XG4gICAgICAgICAgICB0aGlzLnRvZ2dsZV9sb2NhbF92aWRlb19zaXplKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5ldmVudC5vbigncGFydGljaXBhbnREaWREaXNjb25uZWN0JywgKHIpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwicGFydGljaXBhbnREaWREaXNjb25uZWN0XCIpO1xuICAgICAgICAgICAgdGhpcy50b2dnbGVfbG9jYWxfdmlkZW9fc2l6ZSgpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZXZlbnQub24oJ3BhcnRpY2lwYW50VW5wdWJsaXNoZWRBdWRpb1RyYWNrJywgKHIpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwicGFydGljaXBhbnRVbnB1Ymxpc2hlZEF1ZGlvVHJhY2tcIik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5ldmVudC5vbigncGFydGljaXBhbnRQdWJsaXNoZWRWaWRlb1RyYWNrJywgKHIpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwicGFydGljaXBhbnRQdWJsaXNoZWRWaWRlb1RyYWNrXCIpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZXZlbnQub24oJ3BhcnRpY2lwYW50VW5wdWJsaXNoZWRWaWRlb1RyYWNrJywgKHIpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwicGFydGljaXBhbnRVbnB1Ymxpc2hlZFZpZGVvVHJhY2tcIik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5ldmVudC5vbignb25BdWRpb1RyYWNrU3Vic2NyaWJlZCcsIChyKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIm9uQXVkaW9UcmFja1N1YnNjcmliZWRcIik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5ldmVudC5vbignb25BdWRpb1RyYWNrVW5zdWJzY3JpYmVkJywgKHIpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwib25BdWRpb1RyYWNrVW5zdWJzY3JpYmVkXCIpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZXZlbnQub24oJ29uVmlkZW9UcmFja1N1YnNjcmliZWQnLCAocikgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJvblZpZGVvVHJhY2tTdWJzY3JpYmVkXCIpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZXZlbnQub24oJ29uVmlkZW9UcmFja1Vuc3Vic2NyaWJlZCcsIChyKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIm9uVmlkZW9UcmFja1Vuc3Vic2NyaWJlZCAwMFwiKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LmV2ZW50Lm9uKCdwYXJ0aWNpcGFudERpc2FibGVkVmlkZW9UcmFjaycsIChyKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcInBhcnRpY2lwYW50RGlzYWJsZWRWaWRlb1RyYWNrXCIpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZXZlbnQub24oJ3BhcnRpY2lwYW50RW5hYmxlZFZpZGVvVHJhY2snLCAocikgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJwYXJ0aWNpcGFudEVuYWJsZWRWaWRlb1RyYWNrXCIpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZXZlbnQub24oJ3BhcnRpY2lwYW50RGlzYWJsZWRBdWRpb1RyYWNrJywgKHIpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwicGFydGljaXBhbnREaXNhYmxlZEF1ZGlvVHJhY2tcIik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5ldmVudC5vbigncGFydGljaXBhbnRFbmFibGVkQXVkaW9UcmFjaycsIChyKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcInBhcnRpY2lwYW50RW5hYmxlZEF1ZGlvVHJhY2tcIik7XG4gICAgICAgIH0pO1xuXG5cbiAgICAgICAgdGhpcy5nZXRfcGVybWlzc2lvbnMoKVxuICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIC8vIGkgZmluZCB0aGUgc2V0dGltZW91dCBhbGxvd3MgZm9yIGEgc21vb3RoZXIgbG9hZCBpZiB5b3UncmUgbG9va2luZyBmb3IgdGhlIHByZXZpZXcgdG8gYmVnaW4gaW1tZWRpYXRlbHlcbiAgICAgICAgICAgICAgICB2YXIgdCA9IHRpbWVyLnNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuc3RhcnRQcmV2aWV3KCk7XG4gICAgICAgICAgICAgICAgICAgIHRpbWVyLmNsZWFyVGltZW91dCh0KTtcbiAgICAgICAgICAgICAgICB9LCAxMjAwKVxuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgdG9nZ2xlX2xvY2FsX3ZpZGVvX3NpemUoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmxvY2FsVmlkZW8uY2xhc3NOYW1lID09PSAnbGFyZ2UnKSB7XG4gICAgICAgICAgICB0aGlzLmxvY2FsVmlkZW8uY2xhc3NOYW1lID0gJ3NtYWxsJztcbiAgICAgICAgICAgIEdyaWRMYXlvdXQuc2V0Q29sdW1uKHRoaXMubG9jYWxWaWRlbywgMSk7XG4gICAgICAgICAgICBHcmlkTGF5b3V0LnNldFJvdyh0aGlzLmxvY2FsVmlkZW8sIDApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5sb2NhbFZpZGVvLmNsYXNzTmFtZSA9ICdsYXJnZSc7XG4gICAgICAgICAgICBHcmlkTGF5b3V0LnNldENvbHVtbih0aGlzLmxvY2FsVmlkZW8sIDApO1xuICAgICAgICAgICAgR3JpZExheW91dC5zZXRDb2x1bW5TcGFuKHRoaXMubG9jYWxWaWRlbywgMik7XG4gICAgICAgICAgICBHcmlkTGF5b3V0LnNldFJvd1NwYW4odGhpcy5sb2NhbFZpZGVvLCAyKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFkZF92aWRlb192aWV3cygpOiB2b2lkIHtcbiAgICAgICAgLy8gdGhpcy5sb2NhbFZpZGVvLmlkID0gJ2xvY2FsLXZpZGVvJztcbiAgICAgICAgdGhpcy5sb2NhbFZpZGVvLmNsYXNzTmFtZSA9ICdsYXJnZSc7XG4gICAgICAgIHRoaXMucmVtb3RlVmlkZW8uaWQgPSAncmVtb3RlLXZpZGVvJztcblxuICAgICAgICB0aGlzLmxvY2FsVmlkZW8ub24oJ3RhcCcsIHRoaXMudG9nZ2xlX2xvY2FsX3ZpZGVvX3NpemUuYmluZCh0aGlzKSk7XG5cbiAgICAgICAgR3JpZExheW91dC5zZXRDb2x1bW5TcGFuKHRoaXMucmVtb3RlVmlkZW8sIDIpO1xuICAgICAgICBHcmlkTGF5b3V0LnNldFJvd1NwYW4odGhpcy5yZW1vdGVWaWRlbywgMik7XG4gICAgICAgIEdyaWRMYXlvdXQuc2V0Um93KHRoaXMucmVtb3RlVmlkZW8sIDApO1xuICAgICAgICBHcmlkTGF5b3V0LnNldENvbHVtblNwYW4odGhpcy5sb2NhbFZpZGVvLCAyKTtcbiAgICAgICAgR3JpZExheW91dC5zZXRSb3dTcGFuKHRoaXMubG9jYWxWaWRlbywgMik7XG4gICAgICAgIEdyaWRMYXlvdXQuc2V0Um93KHRoaXMubG9jYWxWaWRlbywgMCk7XG4gICAgICAgIHRoaXMuY29udGFpbmVyLmluc2VydENoaWxkKHRoaXMucmVtb3RlVmlkZW8sIDApO1xuICAgICAgICB0aGlzLmNvbnRhaW5lci5pbnNlcnRDaGlsZCh0aGlzLmxvY2FsVmlkZW8sIDApO1xuICAgIH1cblxuXG5cbiAgICBjaGVja19wZXJtaXNzaW9ucygpOiBib29sZWFuIHtcbiAgICAgICAgdmFyIGF1ZGlvLCBjYW1lcmE7XG5cbiAgICAgICAgaWYgKGFwcC5hbmRyb2lkKSB7XG4gICAgICAgICAgICBhdWRpbyA9IHBlcm1pc3Npb25zLmhhc1Blcm1pc3Npb24oXCJhbmRyb2lkLnBlcm1pc3Npb24uUkVDT1JEX0FVRElPXCIpXG4gICAgICAgICAgICBjYW1lcmEgPSBwZXJtaXNzaW9ucy5oYXNQZXJtaXNzaW9uKFwiYW5kcm9pZC5wZXJtaXNzaW9uLkNBTUVSQVwiKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY2FtZXJhID0gQVZDYXB0dXJlRGV2aWNlLmF1dGhvcml6YXRpb25TdGF0dXNGb3JNZWRpYVR5cGUoQVZNZWRpYVR5cGVWaWRlbyk7XG4gICAgICAgICAgICBhdWRpbyA9IEFWQ2FwdHVyZURldmljZS5hdXRob3JpemF0aW9uU3RhdHVzRm9yTWVkaWFUeXBlKEFWTWVkaWFUeXBlQXVkaW8pO1xuICAgICAgICAgICAgaWYgKGNhbWVyYSA8IDMpIGNhbWVyYSA9IGZhbHNlO1xuICAgICAgICAgICAgaWYgKGF1ZGlvIDwgMykgYXVkaW8gPSBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghYXVkaW8gfHwgIWNhbWVyYSkgcmV0dXJuIGZhbHNlO1xuICAgICAgICBlbHNlIHJldHVybiB0cnVlO1xuXG4gICAgfVxuXG4gICAgZ2V0X3Blcm1pc3Npb25zKCk6IFByb21pc2U8YW55PiB7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblxuICAgICAgICAgICAgdmFyIGhhc19wZXJtaXNzaW9ucyA9IHRoaXMuY2hlY2tfcGVybWlzc2lvbnMoKTtcblxuICAgICAgICAgICAgaWYgKGhhc19wZXJtaXNzaW9ucykge1xuICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChhcHAuYW5kcm9pZCkge1xuICAgICAgICAgICAgICAgIHBlcm1pc3Npb25zLnJlcXVlc3RQZXJtaXNzaW9ucyhbXG4gICAgICAgICAgICAgICAgICAgIFwiYW5kcm9pZC5wZXJtaXNzaW9uLlJFQ09SRF9BVURJT1wiLFxuICAgICAgICAgICAgICAgICAgICBcImFuZHJvaWQucGVybWlzc2lvbi5DQU1FUkFcIlxuICAgICAgICAgICAgICAgIF0sIFwiSSBuZWVkIHRoZXNlIHBlcm1pc3Npb25zIGJlY2F1c2UgSSdtIGNvb2xcIilcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmRpcihyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHJlc3BvbnNlKTtcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgLmNhdGNoKChlKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmRpcihlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiVWggb2gsIG5vIHBlcm1pc3Npb25zIC0gcGxhbiBCIHRpbWUhXCIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGhhc19wZXJtaXNzaW9ucyA9IHRoaXMuY2hlY2tfcGVybWlzc2lvbnMoKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFoYXNfcGVybWlzc2lvbnMpIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRpYWxvZ3MuYWxlcnQoXCJ3aXRob3V0IG1pYyBhbmQgY2FtZXJhIHBlcm1pc3Npb25zIFxcbiB5b3UgY2Fubm90IGNvbm5lY3QuIFxcbiBwbGVhc2UgYWxsb3cgcGVybWlzc2lvbnMgaW4gc2V0dGluZ3MgYW5kIHRyeSBhZ2Fpbi5cIikudGhlbigoKSA9PiB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgfSBlbHNlIHtcblxuICAgICAgICAgICAgICAgIFByb21pc2UuYWxsKFt0aGlzLmlvc19taWNfcGVybWlzc2lvbigpLCB0aGlzLmlvc19jYW1lcmFfcGVybWlzc2lvbigpXSlcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4odmFsdWVzID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHZhbHVlcykpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9LCByZWFzb24gPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkocmVhc29uKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNldCgnZXJyb3InLCByZWFzb24pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBkaWFsb2dzLmFsZXJ0KFwid2l0aG91dCBtaWMgYW5kIGNhbWVyYSBwZXJtaXNzaW9ucyBcXG4geW91IGNhbm5vdCBjb25uZWN0LiBcXG4gcGxlYXNlIGFsbG93IHBlcm1pc3Npb25zIGluIHNldHRpbmdzIGFuZCB0cnkgYWdhaW4uXCIpLnRoZW4oKCkgPT4ge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgVUlBcHBsaWNhdGlvbi5zaGFyZWRBcHBsaWNhdGlvbi5vcGVuVVJMKE5TVVJMLlVSTFdpdGhTdHJpbmcoVUlBcHBsaWNhdGlvbk9wZW5TZXR0aW5nc1VSTFN0cmluZykpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KClcblxuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0pXG5cbiAgICB9XG5cbiAgICBpb3NfbWljX3Blcm1pc3Npb24oKTogUHJvbWlzZTxhbnk+IHtcblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXG4gICAgICAgICAgICB2YXIgaGFzX2Fza2VkID0gQVZDYXB0dXJlRGV2aWNlLmF1dGhvcml6YXRpb25TdGF0dXNGb3JNZWRpYVR5cGUoQVZNZWRpYVR5cGVBdWRpbyk7XG5cbiAgICAgICAgICAgIGlmIChoYXNfYXNrZWQgPT09IDIpIHtcbiAgICAgICAgICAgICAgICByZWplY3QoJ21pYyBwZXJtaXNzaW9uIGRlbmllZCcpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgQVZBdWRpb1Nlc3Npb24uc2hhcmVkSW5zdGFuY2UoKS5yZXF1ZXN0UmVjb3JkUGVybWlzc2lvbigoYm9vbCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChib29sID09PSB0cnVlKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoYm9vbCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmVqZWN0KCdtaWMgcGVybWlzc2lvbiBkZW5pZWQnKTtcblxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfSlcblxuICAgIH1cblxuICAgIGlvc19jYW1lcmFfcGVybWlzc2lvbigpOiBQcm9taXNlPGFueT4ge1xuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cbiAgICAgICAgICAgIHZhciBoYXNfYXNrZWQgPSBBVkNhcHR1cmVEZXZpY2UuYXV0aG9yaXphdGlvblN0YXR1c0Zvck1lZGlhVHlwZShBVk1lZGlhVHlwZVZpZGVvKTtcblxuICAgICAgICAgICAgaWYgKGhhc19hc2tlZCA9PT0gMikge1xuICAgICAgICAgICAgICAgIHJlamVjdCgnY2FtZXJhIHBlcm1pc3Npb24gZGVuaWVkJyk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBBVkNhcHR1cmVEZXZpY2UucmVxdWVzdEFjY2Vzc0Zvck1lZGlhVHlwZUNvbXBsZXRpb25IYW5kbGVyKEFWTWVkaWFUeXBlVmlkZW8sIChib29sKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGJvb2wgPT09IHRydWUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShib29sKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZWplY3QoJ2NhbWVyYSBwZXJtaXNzaW9uIGRlbmllZCcpO1xuXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9KVxuICAgIH1cblxuXG4gICAgcHVibGljIGRpc2Nvbm5lY3QoKSB7XG5cbiAgICAgICAgaWYgKHRoaXMudmlkZW9BY3Rpdml0eS5yb29tKSB7XG5cbiAgICAgICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5kaXNjb25uZWN0KCk7XG5cbiAgICAgICAgfVxuXG4gICAgfVxuXG5cbiAgICBwdWJsaWMgdG9nZ2xlX2xvY2FsX2F1ZGlvKCkge1xuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS50b2dnbGVfbG9jYWxfYXVkaW8oKTtcblxuICAgIH1cblxuXG4gICAgcHVibGljIHRvZ2dsZV9sb2NhbF92aWRlbygpIHtcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkudG9nZ2xlX2xvY2FsX3ZpZGVvKCk7XG5cbiAgICB9XG5cbiAgICBwdWJsaWMgY29ubmVjdF90b19yb29tKCk6IHZvaWQge1xuICAgICAgICBpZiAoIXRoaXMuZ2V0KCduYW1lJykgfHwgIXRoaXMuZ2V0KCdyb29tJykgfHwgdGhpcy5nZXQoJ25hbWUnKS5sZW5ndGggPCAxIHx8IHRoaXMuZ2V0KCdyb29tJykubGVuZ3RoIDwgMSlcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnNldCgnZXJyb3InLCBcIk1pc3NpbmcgSW5mby5cIik7XG4gICAgICAgIGVsc2UgdGhpcy5zZXQoJ2Vycm9yJywgXCJcIik7XG4gICAgICAgIHRoaXMuZ2V0X3Rva2VuKClcbiAgICAgICAgICAgIC50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgICAgICAgICAgdmFyIHJlc3VsdCA9IHJlc3VsdC5jb250ZW50LnRvSlNPTigpO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LnNldF9hY2Nlc3NfdG9rZW4ocmVzdWx0Wyd0b2tlbiddKTtcbiAgICAgICAgICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuY29ubmVjdF90b19yb29tKHRoaXMuZ2V0KCdyb29tJyksIHt2aWRlbzogdHJ1ZSwgYXVkaW86IHRydWV9KTtcbiAgICAgICAgICAgIH0sIGUgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuc2V0KCdlcnJvcicsIGUpO1xuICAgICAgICAgICAgfSk7XG4gICAgfVxuXG5cbiAgICBwdWJsaWMgZ2V0X3Rva2VuKCk6IFByb21pc2U8YW55PiB7XG4gICAgICAgIGxldCBuYW1lID0gdGhpcy5nZXQoJ25hbWUnKVxuICAgICAgICByZXR1cm4gaHR0cC5yZXF1ZXN0KHtcbiAgICAgICAgICAgIHVybDogJ2h0dHBzOi8vNzcyMGJhMzEubmdyb2suaW8vZ2V0VG9rZW4nLFxuICAgICAgICAgICAgbWV0aG9kOiBcIlBPU1RcIixcbiAgICAgICAgICAgIGhlYWRlcnM6IHsgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIgfSxcbiAgICAgICAgICAgIGNvbnRlbnQ6IEpTT04uc3RyaW5naWZ5KHsgdWlkOiBuYW1lIH0pXG4gICAgICAgIH0pO1xuICAgIH1cblxuXG59Il19