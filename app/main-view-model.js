"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var observable_1 = require("data/observable");
var app = require("tns-core-modules/application");
var nativescript_twilio_video_1 = require("nativescript-twilio-video");
var http = require("http");
var permissions = require('nativescript-permissions');
var HelloWorldModel = (function (_super) {
    __extends(HelloWorldModel, _super);
    function HelloWorldModel(page) {
        var _this = _super.call(this) || this;
        _this.page = page;
        _this.countdown = 60;
        _this.localVideo = _this.page.getViewById('local-video');
        _this.remoteVideo = _this.page.getViewById('remote-video');
        _this.videoActivity = new nativescript_twilio_video_1.VideoActivity();
        _this.videoActivity.localVideoView = _this.localVideo.localVideoView;
        _this.videoActivity.remoteVideoView = _this.remoteVideo.remoteVideoView;
        _this.videoActivity.createAudioAndVideoTracks();
        _this.getPermissions();
        _this.getToken()
            .then(function (result) {
            console.log('result');
            var result = result.content.toJSON();
            console.log(result['token']);
            _this.videoActivity.set_access_token(result['token']);
        });
        _this.videoActivity.events.on('onConnected', function (data) {
            var room = data.object['room'];
            console.log(room);
            _this.videoActivity.set_listener_for_participants(room);
        });
        _this.videoActivity.events.on('onParticipantConnected', function (data) {
            console.log('onParticipantConnected');
            var participant = data.object['participant'];
            var room = data.object['room'];
            _this.videoActivity.participant_joined_room(participant);
        });
        _this.videoActivity.events.on('onVideoTrackAdded', function (data) {
            console.log('onVideoTrackAdded');
            var videoTrack = data.object['videoTrack'];
            var participant = data.object['participant'];
            _this.videoActivity.add_video_track(videoTrack);
        });
        _this.videoActivity.events.on('onDisconnected', function (data) {
            var room = data.object['room'];
            var error = data.object['error'];
            console.log(error);
            _this.videoActivity.configure_audio(false);
            console.log('onDisconnected');
        });
        _this.videoActivity.events.on('onConnectFailure', function (data) {
            console.log(JSON.stringify(data));
            _this.videoActivity.configure_audio(false);
        });
        _this.videoActivity.events.on('onParticipantDisconnected', function (data) {
            console.log('onParticipantDisconnected');
            var participant = data.object['participant'];
            _this.videoActivity.removeParticipant(participant);
        });
        _this.videoActivity.events.on('onAudioTrackAdded', function (data) {
            console.log('onAudioTrackAdded');
        });
        _this.videoActivity.events.on('onAudioTrackRemoved', function (data) {
            console.log('onAudioTrackRemoved');
        });
        _this.videoActivity.events.on('onVideoTrackRemoved', function (data) {
            console.log('onVideoTrackRemoved');
        });
        _this.videoActivity.events.on('onAudioTrackEnabled', function (data) {
            console.log('onAudioTrackEnabled');
        });
        _this.videoActivity.events.on('onAudioTrackDisabled', function (data) {
            console.log('onAudioTrackDisabled');
        });
        _this.videoActivity.events.on('onVideoTrackEnabled', function (data) {
            console.log('onVideoTrackEnabled');
        });
        _this.videoActivity.events.on('onVideoTrackDisabled', function (data) {
            console.log('onVideoTrackDisabled');
        });
        return _this;
    }
    HelloWorldModel.prototype.getPermissions = function () {
        return new Promise(function (resolve, reject) {
            if (app.android) {
                permissions.requestPermissions([
                    "android.permission.RECORD_AUDIO",
                    "android.permission.CAMERA"
                ], "I need these permissions because I'm cool")
                    .then(function (response) {
                    console.dir(response);
                    resolve();
                })
                    .catch(function (e) {
                    console.dir(e);
                    console.log("Uh oh, no permissions - plan B time!");
                });
            }
            else {
                resolve();
            }
        });
    };
    HelloWorldModel.prototype.disconnect = function () {
        this.videoActivity.roomObj.disconnect();
    };
    HelloWorldModel.prototype.add_time = function () {
    };
    HelloWorldModel.prototype.show_local_video = function () {
        this.videoActivity.createAudioAndVideoTracks();
    };
    HelloWorldModel.prototype.toggle_local_audio = function () {
        this.videoActivity.toggle_local_audio();
    };
    HelloWorldModel.prototype.toggle_local_video = function () {
        this.videoActivity.toggle_local_video();
    };
    HelloWorldModel.prototype.connect_to_room = function () {
        this.videoActivity.connect_to_room('abc');
    };
    HelloWorldModel.prototype.getToken = function () {
        var user = {
            name: ''
        };
        if (app.android) {
            user.name = 'android';
        }
        else {
            user.name = 'ios';
        }
        return http.request({
            url: "https://us-central1-firebase-goblur.cloudfunctions.net/get_token",
            method: "POST",
            headers: { "Content-Type": "application/json" },
            content: JSON.stringify(user)
        });
    };
    return HelloWorldModel;
}(observable_1.Observable));
exports.HelloWorldModel = HelloWorldModel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi12aWV3LW1vZGVsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibWFpbi12aWV3LW1vZGVsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsOENBQXlEO0FBRXpELGtEQUFvRDtBQUVwRCx1RUFBa0Y7QUFFbEYsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzNCLElBQUksV0FBVyxHQUFHLE9BQU8sQ0FBQywwQkFBMEIsQ0FBQyxDQUFDO0FBSXREO0lBQXFDLG1DQUFVO0lBYzNDLHlCQUFvQixJQUFVO1FBQTlCLFlBQ0ksaUJBQU8sU0FxSlY7UUF0Sm1CLFVBQUksR0FBSixJQUFJLENBQU07UUFMdkIsZUFBUyxHQUFXLEVBQUUsQ0FBQztRQVExQixLQUFJLENBQUMsVUFBVSxHQUFlLEtBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRW5FLEtBQUksQ0FBQyxXQUFXLEdBQWdCLEtBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBRXRFLEtBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSx5Q0FBYSxFQUFFLENBQUM7UUFFekMsS0FBSSxDQUFDLGFBQWEsQ0FBQyxjQUFjLEdBQUcsS0FBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUM7UUFFbkUsS0FBSSxDQUFDLGFBQWEsQ0FBQyxlQUFlLEdBQUcsS0FBSSxDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUM7UUFFdEUsS0FBSSxDQUFDLGFBQWEsQ0FBQyx5QkFBeUIsRUFBRSxDQUFBO1FBSTlDLEtBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQTtRQUNyQixLQUFJLENBQUMsUUFBUSxFQUFFO2FBQ1YsSUFBSSxDQUFDLFVBQUMsTUFBTTtZQUNULE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDdEIsSUFBSSxNQUFNLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUVyQyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBRTdCLEtBQUksQ0FBQyxhQUFhLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFFekQsQ0FBQyxDQUFDLENBQUE7UUFLTixLQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsYUFBYSxFQUFFLFVBQUMsSUFBSTtZQUU3QyxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBRS9CLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7WUFFbEIsS0FBSSxDQUFDLGFBQWEsQ0FBQyw2QkFBNkIsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUUzRCxDQUFDLENBQUMsQ0FBQztRQUVILEtBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyx3QkFBd0IsRUFBRSxVQUFDLElBQUk7WUFFeEQsT0FBTyxDQUFDLEdBQUcsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1lBRXRDLElBQUksV0FBVyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUM7WUFFN0MsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUUvQixLQUFJLENBQUMsYUFBYSxDQUFDLHVCQUF1QixDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBTTVELENBQUMsQ0FBQyxDQUFDO1FBRUgsS0FBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLG1CQUFtQixFQUFFLFVBQUMsSUFBSTtZQU1uRCxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixDQUFDLENBQUM7WUFFakMsSUFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUUzQyxJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBRTdDLEtBQUksQ0FBQyxhQUFhLENBQUMsZUFBZSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBR25ELENBQUMsQ0FBQyxDQUFDO1FBRUgsS0FBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLGdCQUFnQixFQUFFLFVBQUMsSUFBSTtZQUVoRCxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBRS9CLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFakMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUVuQixLQUFJLENBQUMsYUFBYSxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUUxQyxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFFbEMsQ0FBQyxDQUFDLENBQUM7UUFJSCxLQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsa0JBQWtCLEVBQUUsVUFBQyxJQUFJO1lBRWxELE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBRWxDLEtBQUksQ0FBQyxhQUFhLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRTlDLENBQUMsQ0FBQyxDQUFDO1FBR0gsS0FBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLDJCQUEyQixFQUFFLFVBQUMsSUFBSTtZQUUzRCxPQUFPLENBQUMsR0FBRyxDQUFDLDJCQUEyQixDQUFDLENBQUM7WUFNekMsSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQztZQUc3QyxLQUFJLENBQUMsYUFBYSxDQUFDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBS3RELENBQUMsQ0FBQyxDQUFDO1FBRUgsS0FBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLG1CQUFtQixFQUFFLFVBQUMsSUFBSTtZQUVuRCxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFFckMsQ0FBQyxDQUFDLENBQUM7UUFFSCxLQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMscUJBQXFCLEVBQUUsVUFBQyxJQUFJO1lBRXJELE9BQU8sQ0FBQyxHQUFHLENBQUMscUJBQXFCLENBQUMsQ0FBQztRQUV2QyxDQUFDLENBQUMsQ0FBQztRQUVILEtBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxxQkFBcUIsRUFBRSxVQUFDLElBQUk7WUFDckQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBQ3ZDLENBQUMsQ0FBQyxDQUFDO1FBRUgsS0FBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLHFCQUFxQixFQUFFLFVBQUMsSUFBSTtZQUNyRCxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFxQixDQUFDLENBQUM7UUFDdkMsQ0FBQyxDQUFDLENBQUM7UUFFSCxLQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsc0JBQXNCLEVBQUUsVUFBQyxJQUFJO1lBQ3RELE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLENBQUMsQ0FBQztRQUN4QyxDQUFDLENBQUMsQ0FBQztRQUVILEtBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxxQkFBcUIsRUFBRSxVQUFDLElBQUk7WUFDckQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO1FBQ3ZDLENBQUMsQ0FBQyxDQUFDO1FBRUgsS0FBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLHNCQUFzQixFQUFFLFVBQUMsSUFBSTtZQUN0RCxPQUFPLENBQUMsR0FBRyxDQUFDLHNCQUFzQixDQUFDLENBQUM7UUFDeEMsQ0FBQyxDQUFDLENBQUM7O0lBRVAsQ0FBQztJQUlELHdDQUFjLEdBQWQ7UUFFSSxNQUFNLENBQUMsSUFBSSxPQUFPLENBQUMsVUFBQyxPQUFPLEVBQUUsTUFBTTtZQUUvQixFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztnQkFFZCxXQUFXLENBQUMsa0JBQWtCLENBQUM7b0JBQzNCLGlDQUFpQztvQkFDakMsMkJBQTJCO2lCQUM5QixFQUFFLDJDQUEyQyxDQUFDO3FCQUMxQyxJQUFJLENBQUMsVUFBQyxRQUFRO29CQUNYLE9BQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7b0JBQ3RCLE9BQU8sRUFBRSxDQUFDO2dCQUNkLENBQUMsQ0FBQztxQkFDRCxLQUFLLENBQUMsVUFBQyxDQUFDO29CQUNMLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ2YsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQ0FBc0MsQ0FBQyxDQUFDO2dCQUN4RCxDQUFDLENBQUMsQ0FBQztZQUVYLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDSixPQUFPLEVBQUUsQ0FBQztZQUNkLENBQUM7UUFHTCxDQUFDLENBQUMsQ0FBQTtJQUdOLENBQUM7SUFHTSxvQ0FBVSxHQUFqQjtRQUVJLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxDQUFDO0lBRTVDLENBQUM7SUFJTSxrQ0FBUSxHQUFmO0lBRUEsQ0FBQztJQUdNLDBDQUFnQixHQUF2QjtRQUVJLElBQUksQ0FBQyxhQUFhLENBQUMseUJBQXlCLEVBQUUsQ0FBQztJQUVuRCxDQUFDO0lBRU0sNENBQWtCLEdBQXpCO1FBRUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO0lBRTVDLENBQUM7SUFHTSw0Q0FBa0IsR0FBekI7UUFFSSxJQUFJLENBQUMsYUFBYSxDQUFDLGtCQUFrQixFQUFFLENBQUM7SUFFNUMsQ0FBQztJQUVNLHlDQUFlLEdBQXRCO1FBR0ksSUFBSSxDQUFDLGFBQWEsQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUM7SUFFOUMsQ0FBQztJQUtNLGtDQUFRLEdBQWY7UUFDSSxJQUFJLElBQUksR0FBRztZQUNQLElBQUksRUFBRSxFQUFFO1NBQ1gsQ0FBQztRQUVGLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBQ2QsSUFBSSxDQUFDLElBQUksR0FBRyxTQUFTLENBQUE7UUFDekIsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ0osSUFBSSxDQUFDLElBQUksR0FBRyxLQUFLLENBQUM7UUFDdEIsQ0FBQztRQUNELE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ2hCLEdBQUcsRUFBRSxrRUFBa0U7WUFDdkUsTUFBTSxFQUFFLE1BQU07WUFDZCxPQUFPLEVBQUUsRUFBRSxjQUFjLEVBQUUsa0JBQWtCLEVBQUU7WUFDL0MsT0FBTyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDO1NBQ2hDLENBQUMsQ0FBQztJQUdQLENBQUM7SUFHTCxzQkFBQztBQUFELENBQUMsQUFyUUQsQ0FBcUMsdUJBQVUsR0FxUTlDO0FBclFZLDBDQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JzZXJ2YWJsZSwgZnJvbU9iamVjdCB9IGZyb20gJ2RhdGEvb2JzZXJ2YWJsZSc7XG5pbXBvcnQgeyBQYWdlIH0gZnJvbSAndWkvcGFnZSc7XG5pbXBvcnQgKiBhcyBhcHAgZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvYXBwbGljYXRpb25cIjtcbmltcG9ydCB7IFZpZXcgfSBmcm9tIFwidWkvY29yZS92aWV3XCJcbmltcG9ydCB7IExvY2FsVmlkZW8sIFZpZGVvQWN0aXZpdHksIFJlbW90ZVZpZGVvfSBmcm9tICduYXRpdmVzY3JpcHQtdHdpbGlvLXZpZGVvJztcblxudmFyIGh0dHAgPSByZXF1aXJlKFwiaHR0cFwiKTtcbnZhciBwZXJtaXNzaW9ucyA9IHJlcXVpcmUoJ25hdGl2ZXNjcmlwdC1wZXJtaXNzaW9ucycpO1xuXG5cblxuZXhwb3J0IGNsYXNzIEhlbGxvV29ybGRNb2RlbCBleHRlbmRzIE9ic2VydmFibGUge1xuICAgIFxuICAgIHByaXZhdGUgbG9jYWxWaWRlbzogTG9jYWxWaWRlbztcbiAgICBwcml2YXRlIHJlbW90ZVZpZGVvOiBSZW1vdGVWaWRlbztcbiAgICBwcml2YXRlIGFjY2Vzc1Rva2VuOiBzdHJpbmc7XG4gICAgcHJpdmF0ZSByb29tTmFtZTogc3RyaW5nO1xuICAgIHB1YmxpYyBuYW1lOiBzdHJpbmc7XG4gICAgcHJpdmF0ZSBoZXJvczogYW55O1xuICAgIHB1YmxpYyBwYXJ0aWNpcGFudDogYW55O1xuICAgIHB1YmxpYyBjb3VudGRvd246IG51bWJlciA9IDYwO1xuICAgIHB1YmxpYyByb29tQnV0dG9uOiBhbnk7XG4gICAgbG9jYWxWaWRlb1ZpZXc6IGFueTtcbiAgICB2aWRlb0FjdGl2aXR5OiBWaWRlb0FjdGl2aXR5O1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBwYWdlOiBQYWdlKSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgdGhpcy5sb2NhbFZpZGVvID0gPExvY2FsVmlkZW8+dGhpcy5wYWdlLmdldFZpZXdCeUlkKCdsb2NhbC12aWRlbycpO1xuXG4gICAgICAgIHRoaXMucmVtb3RlVmlkZW8gPSA8UmVtb3RlVmlkZW8+dGhpcy5wYWdlLmdldFZpZXdCeUlkKCdyZW1vdGUtdmlkZW8nKTtcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkgPSBuZXcgVmlkZW9BY3Rpdml0eSgpO1xuICAgICAgICBcbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LmxvY2FsVmlkZW9WaWV3ID0gdGhpcy5sb2NhbFZpZGVvLmxvY2FsVmlkZW9WaWV3O1xuICAgICAgICBcbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LnJlbW90ZVZpZGVvVmlldyA9IHRoaXMucmVtb3RlVmlkZW8ucmVtb3RlVmlkZW9WaWV3O1xuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5jcmVhdGVBdWRpb0FuZFZpZGVvVHJhY2tzKClcbiAgICAgICAgXG5cblxuICAgICAgICB0aGlzLmdldFBlcm1pc3Npb25zKClcbiAgICAgICAgdGhpcy5nZXRUb2tlbigpICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgLnRoZW4oKHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdyZXN1bHQnKTtcbiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gcmVzdWx0LmNvbnRlbnQudG9KU09OKCk7XG4gICAgICAgICAgICAgICAgLy8gY29uc29sZS5kaXIocmVzdWx0LmNvbnRlbnQpO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlc3VsdFsndG9rZW4nXSk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuc2V0X2FjY2Vzc190b2tlbihyZXN1bHRbJ3Rva2VuJ10pO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICBcblxuXG5cbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LmV2ZW50cy5vbignb25Db25uZWN0ZWQnLCAoZGF0YSkgPT4ge1xuXG4gICAgICAgICAgICBsZXQgcm9vbSA9IGRhdGEub2JqZWN0Wydyb29tJ107XG5cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKHJvb20pO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuc2V0X2xpc3RlbmVyX2Zvcl9wYXJ0aWNpcGFudHMocm9vbSk7XG5cbiAgICAgICAgfSk7ICBcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZXZlbnRzLm9uKCdvblBhcnRpY2lwYW50Q29ubmVjdGVkJywgKGRhdGEpID0+IHtcblxuICAgICAgICAgICAgY29uc29sZS5sb2coJ29uUGFydGljaXBhbnRDb25uZWN0ZWQnKTtcblxuICAgICAgICAgICAgbGV0IHBhcnRpY2lwYW50ID0gZGF0YS5vYmplY3RbJ3BhcnRpY2lwYW50J107XG5cbiAgICAgICAgICAgIGxldCByb29tID0gZGF0YS5vYmplY3RbJ3Jvb20nXTtcblxuICAgICAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LnBhcnRpY2lwYW50X2pvaW5lZF9yb29tKHBhcnRpY2lwYW50KTtcblxuICAgICAgICAgICAgLy8gdGhpcy5wYXJ0aWNpcGFudCA9IGRhdGEub2JqZWN0WydwYXJ0aWNpcGFudCddLmdldElkZW50aXR5KCk7XG5cbiAgICAgICAgICAgIC8vIHRoaXMuc2V0KCdwYXJ0aWNpcGFudCcsIGRhdGEub2JqZWN0WydwYXJ0aWNpcGFudCddLmdldElkZW50aXR5KCkpO1xuXG4gICAgICAgIH0pOyAgIFxuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5ldmVudHMub24oJ29uVmlkZW9UcmFja0FkZGVkJywgKGRhdGEpID0+IHtcblxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiAgYWRkIHZpZGVvIHRyYWNrIGhlcmVcbiAgICAgICAgICAgICAqL1xuXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnb25WaWRlb1RyYWNrQWRkZWQnKTtcblxuICAgICAgICAgICAgbGV0IHZpZGVvVHJhY2sgPSBkYXRhLm9iamVjdFsndmlkZW9UcmFjayddO1xuXG4gICAgICAgICAgICBsZXQgcGFydGljaXBhbnQgPSBkYXRhLm9iamVjdFsncGFydGljaXBhbnQnXTtcblxuICAgICAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LmFkZF92aWRlb190cmFjayh2aWRlb1RyYWNrKTtcblxuXG4gICAgICAgIH0pOyAgICAgICAgICAgICAgXG5cbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LmV2ZW50cy5vbignb25EaXNjb25uZWN0ZWQnLCAoZGF0YSkgPT4ge1xuXG4gICAgICAgICAgICBsZXQgcm9vbSA9IGRhdGEub2JqZWN0Wydyb29tJ107XG5cbiAgICAgICAgICAgIGxldCBlcnJvciA9IGRhdGEub2JqZWN0WydlcnJvciddO1xuXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhlcnJvcik7XG5cbiAgICAgICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5jb25maWd1cmVfYXVkaW8oZmFsc2UpO1xuXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnb25EaXNjb25uZWN0ZWQnKTtcblxuICAgICAgICB9KTsgXG5cbiBcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZXZlbnRzLm9uKCdvbkNvbm5lY3RGYWlsdXJlJywgKGRhdGEpID0+IHtcbiAgICAgICAgICAgIC8vIGxlYXZlIHJvb20uLiByZXF1ZXN0IG5ldyBtYXRjaFxuICAgICAgICAgICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkoZGF0YSkpO1xuXG4gICAgICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuY29uZmlndXJlX2F1ZGlvKGZhbHNlKTtcblxuICAgICAgICB9KTtcblxuIFxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZXZlbnRzLm9uKCdvblBhcnRpY2lwYW50RGlzY29ubmVjdGVkJywgKGRhdGEpID0+IHtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc29sZS5sb2coJ29uUGFydGljaXBhbnREaXNjb25uZWN0ZWQnKTtcblxuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBsZWF2ZSByb29tLi4gcmVxdWVzdCBuZXcgbWF0Y2hcbiAgICAgICAgICAgICAqL1xuXG4gICAgICAgICAgICBsZXQgcGFydGljaXBhbnQgPSBkYXRhLm9iamVjdFsncGFydGljaXBhbnQnXTtcbiAgICAgICAgICAgIFxuXG4gICAgICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkucmVtb3ZlUGFydGljaXBhbnQocGFydGljaXBhbnQpOyAgICAgICAgICAgIFxuICAgICAgICAgICAgXG5cbiAgICAgICAgICAgIC8vIHRoaXMucGFydGljaXBhbnQgPSBkYXRhLm9iamVjdFsncGFydGljaXBhbnQnXS5nZXRJZGVudGl0eSgpO1xuXG4gICAgICAgIH0pOyBcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZXZlbnRzLm9uKCdvbkF1ZGlvVHJhY2tBZGRlZCcsIChkYXRhKSA9PiB7XG5cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdvbkF1ZGlvVHJhY2tBZGRlZCcpO1xuXG4gICAgICAgIH0pOyBcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZXZlbnRzLm9uKCdvbkF1ZGlvVHJhY2tSZW1vdmVkJywgKGRhdGEpID0+IHtcblxuICAgICAgICAgICAgY29uc29sZS5sb2coJ29uQXVkaW9UcmFja1JlbW92ZWQnKTtcblxuICAgICAgICB9KTsgXG5cbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LmV2ZW50cy5vbignb25WaWRlb1RyYWNrUmVtb3ZlZCcsIChkYXRhKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnb25WaWRlb1RyYWNrUmVtb3ZlZCcpO1xuICAgICAgICB9KTsgIFxuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5ldmVudHMub24oJ29uQXVkaW9UcmFja0VuYWJsZWQnLCAoZGF0YSkgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ29uQXVkaW9UcmFja0VuYWJsZWQnKTtcbiAgICAgICAgfSk7ICBcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZXZlbnRzLm9uKCdvbkF1ZGlvVHJhY2tEaXNhYmxlZCcsIChkYXRhKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnb25BdWRpb1RyYWNrRGlzYWJsZWQnKTtcbiAgICAgICAgfSk7IFxuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5ldmVudHMub24oJ29uVmlkZW9UcmFja0VuYWJsZWQnLCAoZGF0YSkgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ29uVmlkZW9UcmFja0VuYWJsZWQnKTtcbiAgICAgICAgfSk7ICBcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZXZlbnRzLm9uKCdvblZpZGVvVHJhY2tEaXNhYmxlZCcsIChkYXRhKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnb25WaWRlb1RyYWNrRGlzYWJsZWQnKTtcbiAgICAgICAgfSk7ICAgICAgICAgIFxuXG4gICAgfVxuXG5cblxuICAgIGdldFBlcm1pc3Npb25zKCk6IFByb21pc2U8YW55PiB7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblxuICAgICAgICAgICAgaWYgKGFwcC5hbmRyb2lkKSB7XG5cbiAgICAgICAgICAgICAgICBwZXJtaXNzaW9ucy5yZXF1ZXN0UGVybWlzc2lvbnMoW1xuICAgICAgICAgICAgICAgICAgICBcImFuZHJvaWQucGVybWlzc2lvbi5SRUNPUkRfQVVESU9cIixcbiAgICAgICAgICAgICAgICAgICAgXCJhbmRyb2lkLnBlcm1pc3Npb24uQ0FNRVJBXCJcbiAgICAgICAgICAgICAgICBdLCBcIkkgbmVlZCB0aGVzZSBwZXJtaXNzaW9ucyBiZWNhdXNlIEknbSBjb29sXCIpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5kaXIocmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAuY2F0Y2goKGUpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZGlyKGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJVaCBvaCwgbm8gcGVybWlzc2lvbnMgLSBwbGFuIEIgdGltZSFcIik7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgXG4gICAgICAgIH0pXG5cblxuICAgIH1cblxuXG4gICAgcHVibGljIGRpc2Nvbm5lY3QoKSB7XG5cbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LnJvb21PYmouZGlzY29ubmVjdCgpO1xuXG4gICAgfVxuXG5cblxuICAgIHB1YmxpYyBhZGRfdGltZSgpIHtcbiAgICAgICAgLy8gY29uc29sZS5kaXIoVFZJQ2FtZXJhQ2FwdHVyZXIuYWxsb2MoKS5pbml0KCkuaW5pdFdpdGhGcmFtZURlbGVnYXRlKCkpO1xuICAgIH1cblxuXG4gICAgcHVibGljIHNob3dfbG9jYWxfdmlkZW8oKSB7XG5cbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LmNyZWF0ZUF1ZGlvQW5kVmlkZW9UcmFja3MoKTtcblxuICAgIH1cblxuICAgIHB1YmxpYyB0b2dnbGVfbG9jYWxfYXVkaW8oKSB7XG5cbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LnRvZ2dsZV9sb2NhbF9hdWRpbygpO1xuXG4gICAgfVxuXG5cbiAgICBwdWJsaWMgdG9nZ2xlX2xvY2FsX3ZpZGVvKCkge1xuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS50b2dnbGVfbG9jYWxfdmlkZW8oKTtcblxuICAgIH1cblxuICAgIHB1YmxpYyBjb25uZWN0X3RvX3Jvb20oKTogdm9pZCB7ICAgIFxuICAgICAgICAgICBcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuY29ubmVjdF90b19yb29tKCdhYmMnKTtcblxuICAgIH1cblxuXG5cblxuICAgIHB1YmxpYyBnZXRUb2tlbigpOiBhbnkge1xuICAgICAgICBsZXQgdXNlciA9IHtcbiAgICAgICAgICAgIG5hbWU6ICcnXG4gICAgICAgIH07XG5cbiAgICAgICAgaWYgKGFwcC5hbmRyb2lkKSB7XG4gICAgICAgICAgICB1c2VyLm5hbWUgPSAnYW5kcm9pZCdcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHVzZXIubmFtZSA9ICdpb3MnO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBodHRwLnJlcXVlc3Qoe1xuICAgICAgICAgICAgdXJsOiBcImh0dHBzOi8vdXMtY2VudHJhbDEtZmlyZWJhc2UtZ29ibHVyLmNsb3VkZnVuY3Rpb25zLm5ldC9nZXRfdG9rZW5cIixcbiAgICAgICAgICAgIG1ldGhvZDogXCJQT1NUXCIsXG4gICAgICAgICAgICBoZWFkZXJzOiB7IFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiIH0sXG4gICAgICAgICAgICBjb250ZW50OiBKU09OLnN0cmluZ2lmeSh1c2VyKVxuICAgICAgICB9KTtcblxuXG4gICAgfVxuXG5cbn0iXX0=