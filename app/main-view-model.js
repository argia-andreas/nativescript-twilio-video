"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var observable_1 = require("data/observable");
var app = require("tns-core-modules/application");
var nativescript_twilio_video_1 = require("nativescript-twilio-video");
var dialogs = require("ui/dialogs");
var grid_layout_1 = require("ui/layouts/grid-layout");
var http = require("http");
var permissions = require('nativescript-permissions');
var timer = require("timer");
var VideoChat = (function (_super) {
    __extends(VideoChat, _super);
    function VideoChat(page) {
        var _this = _super.call(this) || this;
        _this.page = page;
        _this.container = _this.page.getViewById('container');
        _this.videoActivity = new nativescript_twilio_video_1.VideoActivity();
        _this.localVideo = new nativescript_twilio_video_1.LocalVideo();
        _this.remoteVideo = new nativescript_twilio_video_1.RemoteVideo();
        _this.videoActivity.localVideoView = _this.localVideo.localVideoView;
        _this.videoActivity.remoteVideoView = _this.remoteVideo.remoteVideoView;
        _this.add_video_views();
        _this.videoActivity.event.on('error', function (reason) {
            _this.set("error", reason.object['reason']);
            console.log(JSON.stringify(reason.object['reason']));
        });
        _this.videoActivity.event.on('didConnectToRoom', function (r) {
            if (r.object['count'] < 1)
                return;
            console.log("didConnectToRoom");
            _this.toggle_local_video_size();
        });
        _this.videoActivity.event.on('didFailToConnectWithError', function (r) {
            console.log("didFailToConnectWithError");
        });
        _this.videoActivity.event.on('participantDidConnect', function (r) {
            if (r.object['count'] < 1)
                return;
            console.log("participantDidConnect");
            _this.toggle_local_video_size();
        });
        _this.videoActivity.event.on('participantDidDisconnect', function (r) {
            console.log("participantDidDisconnect");
            _this.toggle_local_video_size();
        });
        _this.videoActivity.event.on('participantUnpublishedAudioTrack', function (r) {
            console.log("participantUnpublishedAudioTrack");
        });
        _this.videoActivity.event.on('participantPublishedVideoTrack', function (r) {
            console.log("participantPublishedVideoTrack");
        });
        _this.videoActivity.event.on('participantUnpublishedVideoTrack', function (r) {
            console.log("participantUnpublishedVideoTrack");
        });
        _this.videoActivity.event.on('onAudioTrackSubscribed', function (r) {
            console.log("onAudioTrackSubscribed");
        });
        _this.videoActivity.event.on('onAudioTrackUnsubscribed', function (r) {
            console.log("onAudioTrackUnsubscribed");
        });
        _this.videoActivity.event.on('onVideoTrackSubscribed', function (r) {
            console.log("onVideoTrackSubscribed");
        });
        _this.videoActivity.event.on('onVideoTrackUnsubscribed', function (r) {
            console.log("onVideoTrackUnsubscribed 00");
        });
        _this.videoActivity.event.on('participantDisabledVideoTrack', function (r) {
            console.log("participantDisabledVideoTrack");
        });
        _this.videoActivity.event.on('participantEnabledVideoTrack', function (r) {
            console.log("participantEnabledVideoTrack");
        });
        _this.videoActivity.event.on('participantDisabledAudioTrack', function (r) {
            console.log("participantDisabledAudioTrack");
        });
        _this.videoActivity.event.on('participantEnabledAudioTrack', function (r) {
            console.log("participantEnabledAudioTrack");
        });
        _this.get_permissions()
            .then(function () {
            var t = timer.setTimeout(function () {
                _this.videoActivity.startPreview();
                timer.clearTimeout(t);
            }, 1200);
        });
        return _this;
    }
    VideoChat.prototype.toggle_local_video_size = function () {
        if (this.localVideo.className === 'large') {
            this.localVideo.className = 'small';
            grid_layout_1.GridLayout.setColumn(this.localVideo, 1);
            grid_layout_1.GridLayout.setRow(this.localVideo, 0);
        }
        else {
            this.localVideo.className = 'large';
            grid_layout_1.GridLayout.setColumn(this.localVideo, 0);
            grid_layout_1.GridLayout.setColumnSpan(this.localVideo, 2);
            grid_layout_1.GridLayout.setRowSpan(this.localVideo, 2);
        }
    };
    VideoChat.prototype.add_video_views = function () {
        this.localVideo.className = 'large';
        this.remoteVideo.id = 'remote-video';
        this.localVideo.on('tap', this.toggle_local_video_size.bind(this));
        grid_layout_1.GridLayout.setColumnSpan(this.remoteVideo, 2);
        grid_layout_1.GridLayout.setRowSpan(this.remoteVideo, 2);
        grid_layout_1.GridLayout.setRow(this.remoteVideo, 0);
        grid_layout_1.GridLayout.setColumnSpan(this.localVideo, 2);
        grid_layout_1.GridLayout.setRowSpan(this.localVideo, 2);
        grid_layout_1.GridLayout.setRow(this.localVideo, 0);
        this.container.insertChild(this.remoteVideo, 0);
        this.container.insertChild(this.localVideo, 0);
    };
    VideoChat.prototype.check_permissions = function () {
        var audio, camera;
        if (app.android) {
            audio = permissions.hasPermission("android.permission.RECORD_AUDIO");
            camera = permissions.hasPermission("android.permission.CAMERA");
        }
        else {
            camera = AVCaptureDevice.authorizationStatusForMediaType(AVMediaTypeVideo);
            audio = AVCaptureDevice.authorizationStatusForMediaType(AVMediaTypeAudio);
            if (camera < 3)
                camera = false;
            if (audio < 3)
                audio = false;
        }
        if (!audio || !camera)
            return false;
        else
            return true;
    };
    VideoChat.prototype.get_permissions = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            var has_permissions = _this.check_permissions();
            if (has_permissions) {
                resolve();
                return;
            }
            if (app.android) {
                permissions.requestPermissions([
                    "android.permission.RECORD_AUDIO",
                    "android.permission.CAMERA"
                ], "I need these permissions because I'm cool")
                    .then(function (response) {
                    console.dir(response);
                    resolve(response);
                })
                    .catch(function (e) {
                    console.dir(e);
                    console.log("Uh oh, no permissions - plan B time!");
                    var has_permissions = _this.check_permissions();
                    if (!has_permissions) {
                        dialogs.alert("without mic and camera permissions \n you cannot connect. \n please allow permissions in settings and try again.").then(function () {
                        });
                    }
                });
            }
            else {
                Promise.all([_this.ios_mic_permission(), _this.ios_camera_permission()])
                    .then(function (values) {
                    console.log(JSON.stringify(values));
                    resolve();
                }, function (reason) {
                    console.log(JSON.stringify(reason));
                    _this.set('error', reason);
                    dialogs.alert("without mic and camera permissions \n you cannot connect. \n please allow permissions in settings and try again.").then(function () {
                        UIApplication.sharedApplication.openURL(NSURL.URLWithString(UIApplicationOpenSettingsURLString));
                    });
                    reject();
                });
            }
        });
    };
    VideoChat.prototype.ios_mic_permission = function () {
        return new Promise(function (resolve, reject) {
            var has_asked = AVCaptureDevice.authorizationStatusForMediaType(AVMediaTypeAudio);
            if (has_asked === 2) {
                reject('mic permission denied');
                return;
            }
            AVAudioSession.sharedInstance().requestRecordPermission(function (bool) {
                if (bool === true) {
                    resolve(bool);
                    return;
                }
                reject('mic permission denied');
            });
        });
    };
    VideoChat.prototype.ios_camera_permission = function () {
        return new Promise(function (resolve, reject) {
            var has_asked = AVCaptureDevice.authorizationStatusForMediaType(AVMediaTypeVideo);
            if (has_asked === 2) {
                reject('camera permission denied');
                return;
            }
            AVCaptureDevice.requestAccessForMediaTypeCompletionHandler(AVMediaTypeVideo, function (bool) {
                if (bool === true) {
                    resolve(bool);
                    return;
                }
                reject('camera permission denied');
            });
        });
    };
    VideoChat.prototype.disconnect = function () {
        if (this.videoActivity.room) {
            this.videoActivity.disconnect();
        }
    };
    VideoChat.prototype.toggle_local_audio = function () {
        this.videoActivity.toggle_local_audio();
    };
    VideoChat.prototype.toggle_local_video = function () {
        this.videoActivity.toggle_local_video();
    };
    VideoChat.prototype.connect_to_room = function () {
        var _this = this;
        if (!this.get('name') || !this.get('room') || this.get('name').length < 1 || this.get('room').length < 1)
            return this.set('error', "Missing Info.");
        else
            this.set('error', "");
        this.get_token()
            .then(function (result) {
            var result = result.content.toJSON();
            _this.videoActivity.set_access_token(result['token']);
            _this.videoActivity.connect_to_room(_this.get('room'));
        }, function (e) {
            _this.set('error', e);
        });
    };
    VideoChat.prototype.get_token = function () {
        var name = this.get('name');
        return http.request({
            url: "https://us-central1-firebase-goblur.cloudfunctions.net/get_token",
            method: "POST",
            headers: { "Content-Type": "application/json" },
            content: JSON.stringify({ uid: name })
        });
    };
    return VideoChat;
}(observable_1.Observable));
exports.VideoChat = VideoChat;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi12aWV3LW1vZGVsLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibWFpbi12aWV3LW1vZGVsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsOENBQXlEO0FBRXpELGtEQUFvRDtBQUNwRCx1RUFBbUY7QUFDbkYsb0NBQXNDO0FBRXRDLHNEQUE4RDtBQUU5RCxJQUFNLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDN0IsSUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLDBCQUEwQixDQUFDLENBQUM7QUFDeEQsSUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBSS9CO0lBQStCLDZCQUFVO0lBV3JDLG1CQUFvQixJQUFVO1FBQTlCLFlBQ0ksaUJBQU8sU0FnR1Y7UUFqR21CLFVBQUksR0FBSixJQUFJLENBQU07UUFHMUIsS0FBSSxDQUFDLFNBQVMsR0FBZ0IsS0FBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFakUsS0FBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLHlDQUFhLEVBQUUsQ0FBQztRQUV6QyxLQUFJLENBQUMsVUFBVSxHQUFHLElBQUksc0NBQVUsRUFBRSxDQUFDO1FBRW5DLEtBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSx1Q0FBVyxFQUFFLENBQUM7UUFFckMsS0FBSSxDQUFDLGFBQWEsQ0FBQyxjQUFjLEdBQUcsS0FBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLENBQUM7UUFFbkUsS0FBSSxDQUFDLGFBQWEsQ0FBQyxlQUFlLEdBQUcsS0FBSSxDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUM7UUFFdEUsS0FBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBRXZCLEtBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsVUFBQyxNQUFNO1lBQ3hDLEtBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxNQUFNLENB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QyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBR0wsZ0JBQUM7QUFBRCxDQUFDLEFBOVRELENBQStCLHVCQUFVLEdBOFR4QztBQTlUWSw4QkFBUyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9ic2VydmFibGUsIGZyb21PYmplY3QgfSBmcm9tICdkYXRhL29ic2VydmFibGUnO1xuaW1wb3J0IHsgUGFnZSB9IGZyb20gJ3VpL3BhZ2UnO1xuaW1wb3J0ICogYXMgYXBwIGZyb20gXCJ0bnMtY29yZS1tb2R1bGVzL2FwcGxpY2F0aW9uXCI7XG5pbXBvcnQgeyBMb2NhbFZpZGVvLCBWaWRlb0FjdGl2aXR5LCBSZW1vdGVWaWRlbyB9IGZyb20gJ25hdGl2ZXNjcmlwdC10d2lsaW8tdmlkZW8nO1xuaW1wb3J0ICogYXMgZGlhbG9ncyBmcm9tIFwidWkvZGlhbG9nc1wiO1xuaW1wb3J0IHsgU3RhY2tMYXlvdXQgfSBmcm9tICd0bnMtY29yZS1tb2R1bGVzL3VpL2xheW91dHMvc3RhY2stbGF5b3V0L3N0YWNrLWxheW91dCc7XG5pbXBvcnQgeyBHcmlkTGF5b3V0LCBJdGVtU3BlYyB9IGZyb20gJ3VpL2xheW91dHMvZ3JpZC1sYXlvdXQnO1xuXG5jb25zdCBodHRwID0gcmVxdWlyZShcImh0dHBcIik7XG5jb25zdCBwZXJtaXNzaW9ucyA9IHJlcXVpcmUoJ25hdGl2ZXNjcmlwdC1wZXJtaXNzaW9ucycpO1xuY29uc3QgdGltZXIgPSByZXF1aXJlKFwidGltZXJcIik7XG5cblxuXG5leHBvcnQgY2xhc3MgVmlkZW9DaGF0IGV4dGVuZHMgT2JzZXJ2YWJsZSB7XG4gICAgXG4gICAgcHVibGljIGNvbnRhaW5lcjogYW55O1xuICAgIHB1YmxpYyBsb2NhbFZpZGVvOiBMb2NhbFZpZGVvO1xuICAgIHB1YmxpYyByZW1vdGVWaWRlbzogUmVtb3RlVmlkZW87XG4gICAgcHVibGljIGFjY2Vzc1Rva2VuOiBzdHJpbmc7XG4gICAgcHVibGljIHJvb206IHN0cmluZztcbiAgICBwdWJsaWMgbmFtZTogc3RyaW5nO1xuICAgIHB1YmxpYyBlcnJvcjogc3RyaW5nO1xuICAgIHB1YmxpYyB2aWRlb0FjdGl2aXR5OiBWaWRlb0FjdGl2aXR5O1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBwYWdlOiBQYWdlKSB7XG4gICAgICAgIHN1cGVyKCk7XG5cbiAgICAgICAgdGhpcy5jb250YWluZXIgPSA8U3RhY2tMYXlvdXQ+dGhpcy5wYWdlLmdldFZpZXdCeUlkKCdjb250YWluZXInKTtcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkgPSBuZXcgVmlkZW9BY3Rpdml0eSgpO1xuXG4gICAgICAgIHRoaXMubG9jYWxWaWRlbyA9IG5ldyBMb2NhbFZpZGVvKCk7XG5cbiAgICAgICAgdGhpcy5yZW1vdGVWaWRlbyA9IG5ldyBSZW1vdGVWaWRlbygpO1xuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5sb2NhbFZpZGVvVmlldyA9IHRoaXMubG9jYWxWaWRlby5sb2NhbFZpZGVvVmlldztcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkucmVtb3RlVmlkZW9WaWV3ID0gdGhpcy5yZW1vdGVWaWRlby5yZW1vdGVWaWRlb1ZpZXc7XG5cbiAgICAgICAgdGhpcy5hZGRfdmlkZW9fdmlld3MoKTtcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZXZlbnQub24oJ2Vycm9yJywgKHJlYXNvbikgPT4ge1xuICAgICAgICAgICAgdGhpcy5zZXQoXCJlcnJvclwiLCByZWFzb24ub2JqZWN0WydyZWFzb24nXSk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShyZWFzb24ub2JqZWN0WydyZWFzb24nXSkpO1xuICAgICAgICB9KTtcblxuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5ldmVudC5vbignZGlkQ29ubmVjdFRvUm9vbScsIChyKSA9PiB7XG4gICAgICAgICAgICBpZiAoci5vYmplY3RbJ2NvdW50J10gPCAxKSByZXR1cm47XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcImRpZENvbm5lY3RUb1Jvb21cIik7XG4gICAgICAgICAgICB0aGlzLnRvZ2dsZV9sb2NhbF92aWRlb19zaXplKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5ldmVudC5vbignZGlkRmFpbFRvQ29ubmVjdFdpdGhFcnJvcicsIChyKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcImRpZEZhaWxUb0Nvbm5lY3RXaXRoRXJyb3JcIik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5ldmVudC5vbigncGFydGljaXBhbnREaWRDb25uZWN0JywgKHIpID0+IHtcbiAgICAgICAgICAgIGlmIChyLm9iamVjdFsnY291bnQnXSA8IDEpIHJldHVybjtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwicGFydGljaXBhbnREaWRDb25uZWN0XCIpO1xuICAgICAgICAgICAgdGhpcy50b2dnbGVfbG9jYWxfdmlkZW9fc2l6ZSgpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZXZlbnQub24oJ3BhcnRpY2lwYW50RGlkRGlzY29ubmVjdCcsIChyKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcInBhcnRpY2lwYW50RGlkRGlzY29ubmVjdFwiKTtcbiAgICAgICAgICAgIHRoaXMudG9nZ2xlX2xvY2FsX3ZpZGVvX3NpemUoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LmV2ZW50Lm9uKCdwYXJ0aWNpcGFudFVucHVibGlzaGVkQXVkaW9UcmFjaycsIChyKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcInBhcnRpY2lwYW50VW5wdWJsaXNoZWRBdWRpb1RyYWNrXCIpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZXZlbnQub24oJ3BhcnRpY2lwYW50UHVibGlzaGVkVmlkZW9UcmFjaycsIChyKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcInBhcnRpY2lwYW50UHVibGlzaGVkVmlkZW9UcmFja1wiKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LmV2ZW50Lm9uKCdwYXJ0aWNpcGFudFVucHVibGlzaGVkVmlkZW9UcmFjaycsIChyKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcInBhcnRpY2lwYW50VW5wdWJsaXNoZWRWaWRlb1RyYWNrXCIpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZXZlbnQub24oJ29uQXVkaW9UcmFja1N1YnNjcmliZWQnLCAocikgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJvbkF1ZGlvVHJhY2tTdWJzY3JpYmVkXCIpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZXZlbnQub24oJ29uQXVkaW9UcmFja1Vuc3Vic2NyaWJlZCcsIChyKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIm9uQXVkaW9UcmFja1Vuc3Vic2NyaWJlZFwiKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LmV2ZW50Lm9uKCdvblZpZGVvVHJhY2tTdWJzY3JpYmVkJywgKHIpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwib25WaWRlb1RyYWNrU3Vic2NyaWJlZFwiKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LmV2ZW50Lm9uKCdvblZpZGVvVHJhY2tVbnN1YnNjcmliZWQnLCAocikgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJvblZpZGVvVHJhY2tVbnN1YnNjcmliZWQgMDBcIik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5ldmVudC5vbigncGFydGljaXBhbnREaXNhYmxlZFZpZGVvVHJhY2snLCAocikgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJwYXJ0aWNpcGFudERpc2FibGVkVmlkZW9UcmFja1wiKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LmV2ZW50Lm9uKCdwYXJ0aWNpcGFudEVuYWJsZWRWaWRlb1RyYWNrJywgKHIpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwicGFydGljaXBhbnRFbmFibGVkVmlkZW9UcmFja1wiKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LmV2ZW50Lm9uKCdwYXJ0aWNpcGFudERpc2FibGVkQXVkaW9UcmFjaycsIChyKSA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcInBhcnRpY2lwYW50RGlzYWJsZWRBdWRpb1RyYWNrXCIpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZXZlbnQub24oJ3BhcnRpY2lwYW50RW5hYmxlZEF1ZGlvVHJhY2snLCAocikgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJwYXJ0aWNpcGFudEVuYWJsZWRBdWRpb1RyYWNrXCIpO1xuICAgICAgICB9KTtcblxuXG4gICAgICAgIHRoaXMuZ2V0X3Blcm1pc3Npb25zKClcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICAvLyBpIGZpbmQgdGhlIHNldHRpbWVvdXQgYWxsb3dzIGZvciBhIHNtb290aGVyIGxvYWQgaWYgeW91J3JlIGxvb2tpbmcgZm9yIHRoZSBwcmV2aWV3IHRvIGJlZ2luIGltbWVkaWF0ZWx5XG4gICAgICAgICAgICAgICAgdmFyIHQgPSB0aW1lci5zZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LnN0YXJ0UHJldmlldygpO1xuICAgICAgICAgICAgICAgICAgICB0aW1lci5jbGVhclRpbWVvdXQodCk7XG4gICAgICAgICAgICAgICAgfSwgMTIwMClcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIHRvZ2dsZV9sb2NhbF92aWRlb19zaXplKCk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5sb2NhbFZpZGVvLmNsYXNzTmFtZSA9PT0gJ2xhcmdlJykge1xuICAgICAgICAgICAgdGhpcy5sb2NhbFZpZGVvLmNsYXNzTmFtZSA9ICdzbWFsbCc7XG4gICAgICAgICAgICBHcmlkTGF5b3V0LnNldENvbHVtbih0aGlzLmxvY2FsVmlkZW8sIDEpO1xuICAgICAgICAgICAgR3JpZExheW91dC5zZXRSb3codGhpcy5sb2NhbFZpZGVvLCAwKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMubG9jYWxWaWRlby5jbGFzc05hbWUgPSAnbGFyZ2UnO1xuICAgICAgICAgICAgR3JpZExheW91dC5zZXRDb2x1bW4odGhpcy5sb2NhbFZpZGVvLCAwKTtcbiAgICAgICAgICAgIEdyaWRMYXlvdXQuc2V0Q29sdW1uU3Bhbih0aGlzLmxvY2FsVmlkZW8sIDIpO1xuICAgICAgICAgICAgR3JpZExheW91dC5zZXRSb3dTcGFuKHRoaXMubG9jYWxWaWRlbywgMik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhZGRfdmlkZW9fdmlld3MoKTogdm9pZCB7XG4gICAgICAgIC8vIHRoaXMubG9jYWxWaWRlby5pZCA9ICdsb2NhbC12aWRlbyc7XG4gICAgICAgIHRoaXMubG9jYWxWaWRlby5jbGFzc05hbWUgPSAnbGFyZ2UnO1xuICAgICAgICB0aGlzLnJlbW90ZVZpZGVvLmlkID0gJ3JlbW90ZS12aWRlbyc7XG5cbiAgICAgICAgdGhpcy5sb2NhbFZpZGVvLm9uKCd0YXAnLCB0aGlzLnRvZ2dsZV9sb2NhbF92aWRlb19zaXplLmJpbmQodGhpcykpO1xuXG4gICAgICAgIEdyaWRMYXlvdXQuc2V0Q29sdW1uU3Bhbih0aGlzLnJlbW90ZVZpZGVvLCAyKTtcbiAgICAgICAgR3JpZExheW91dC5zZXRSb3dTcGFuKHRoaXMucmVtb3RlVmlkZW8sIDIpO1xuICAgICAgICBHcmlkTGF5b3V0LnNldFJvdyh0aGlzLnJlbW90ZVZpZGVvLCAwKTtcbiAgICAgICAgR3JpZExheW91dC5zZXRDb2x1bW5TcGFuKHRoaXMubG9jYWxWaWRlbywgMik7XG4gICAgICAgIEdyaWRMYXlvdXQuc2V0Um93U3Bhbih0aGlzLmxvY2FsVmlkZW8sIDIpO1xuICAgICAgICBHcmlkTGF5b3V0LnNldFJvdyh0aGlzLmxvY2FsVmlkZW8sIDApO1xuICAgICAgICB0aGlzLmNvbnRhaW5lci5pbnNlcnRDaGlsZCh0aGlzLnJlbW90ZVZpZGVvLCAwKTtcbiAgICAgICAgdGhpcy5jb250YWluZXIuaW5zZXJ0Q2hpbGQodGhpcy5sb2NhbFZpZGVvLCAwKTtcbiAgICB9XG5cblxuXG4gICAgY2hlY2tfcGVybWlzc2lvbnMoKTogYm9vbGVhbiB7XG4gICAgICAgIHZhciBhdWRpbywgY2FtZXJhO1xuXG4gICAgICAgIGlmIChhcHAuYW5kcm9pZCkge1xuICAgICAgICAgICAgYXVkaW8gPSBwZXJtaXNzaW9ucy5oYXNQZXJtaXNzaW9uKFwiYW5kcm9pZC5wZXJtaXNzaW9uLlJFQ09SRF9BVURJT1wiKVxuICAgICAgICAgICAgY2FtZXJhID0gcGVybWlzc2lvbnMuaGFzUGVybWlzc2lvbihcImFuZHJvaWQucGVybWlzc2lvbi5DQU1FUkFcIilcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNhbWVyYSA9IEFWQ2FwdHVyZURldmljZS5hdXRob3JpemF0aW9uU3RhdHVzRm9yTWVkaWFUeXBlKEFWTWVkaWFUeXBlVmlkZW8pO1xuICAgICAgICAgICAgYXVkaW8gPSBBVkNhcHR1cmVEZXZpY2UuYXV0aG9yaXphdGlvblN0YXR1c0Zvck1lZGlhVHlwZShBVk1lZGlhVHlwZUF1ZGlvKTtcbiAgICAgICAgICAgIGlmIChjYW1lcmEgPCAzKSBjYW1lcmEgPSBmYWxzZTtcbiAgICAgICAgICAgIGlmIChhdWRpbyA8IDMpIGF1ZGlvID0gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWF1ZGlvIHx8ICFjYW1lcmEpIHJldHVybiBmYWxzZTtcbiAgICAgICAgZWxzZSByZXR1cm4gdHJ1ZTtcblxuICAgIH1cblxuICAgIGdldF9wZXJtaXNzaW9ucygpOiBQcm9taXNlPGFueT4ge1xuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG5cbiAgICAgICAgICAgIHZhciBoYXNfcGVybWlzc2lvbnMgPSB0aGlzLmNoZWNrX3Blcm1pc3Npb25zKCk7XG5cbiAgICAgICAgICAgIGlmIChoYXNfcGVybWlzc2lvbnMpIHtcbiAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoYXBwLmFuZHJvaWQpIHtcbiAgICAgICAgICAgICAgICBwZXJtaXNzaW9ucy5yZXF1ZXN0UGVybWlzc2lvbnMoW1xuICAgICAgICAgICAgICAgICAgICBcImFuZHJvaWQucGVybWlzc2lvbi5SRUNPUkRfQVVESU9cIixcbiAgICAgICAgICAgICAgICAgICAgXCJhbmRyb2lkLnBlcm1pc3Npb24uQ0FNRVJBXCJcbiAgICAgICAgICAgICAgICBdLCBcIkkgbmVlZCB0aGVzZSBwZXJtaXNzaW9ucyBiZWNhdXNlIEknbSBjb29sXCIpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5kaXIocmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXNwb25zZSk7XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgIC5jYXRjaCgoZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5kaXIoZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlVoIG9oLCBubyBwZXJtaXNzaW9ucyAtIHBsYW4gQiB0aW1lIVwiKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBoYXNfcGVybWlzc2lvbnMgPSB0aGlzLmNoZWNrX3Blcm1pc3Npb25zKCk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaGFzX3Blcm1pc3Npb25zKSB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaWFsb2dzLmFsZXJ0KFwid2l0aG91dCBtaWMgYW5kIGNhbWVyYSBwZXJtaXNzaW9ucyBcXG4geW91IGNhbm5vdCBjb25uZWN0LiBcXG4gcGxlYXNlIGFsbG93IHBlcm1pc3Npb25zIGluIHNldHRpbmdzIGFuZCB0cnkgYWdhaW4uXCIpLnRoZW4oKCkgPT4ge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIH0gZWxzZSB7XG5cbiAgICAgICAgICAgICAgICBQcm9taXNlLmFsbChbdGhpcy5pb3NfbWljX3Blcm1pc3Npb24oKSwgdGhpcy5pb3NfY2FtZXJhX3Blcm1pc3Npb24oKV0pXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKHZhbHVlcyA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeSh2YWx1ZXMpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgfSwgcmVhc29uID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KHJlYXNvbikpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zZXQoJ2Vycm9yJywgcmVhc29uKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgZGlhbG9ncy5hbGVydChcIndpdGhvdXQgbWljIGFuZCBjYW1lcmEgcGVybWlzc2lvbnMgXFxuIHlvdSBjYW5ub3QgY29ubmVjdC4gXFxuIHBsZWFzZSBhbGxvdyBwZXJtaXNzaW9ucyBpbiBzZXR0aW5ncyBhbmQgdHJ5IGFnYWluLlwiKS50aGVuKCgpID0+IHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFVJQXBwbGljYXRpb24uc2hhcmVkQXBwbGljYXRpb24ub3BlblVSTChOU1VSTC5VUkxXaXRoU3RyaW5nKFVJQXBwbGljYXRpb25PcGVuU2V0dGluZ3NVUkxTdHJpbmcpKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHJlamVjdCgpXG5cbiAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIH1cblxuICAgICAgICB9KVxuXG4gICAgfVxuXG4gICAgaW9zX21pY19wZXJtaXNzaW9uKCk6IFByb21pc2U8YW55PiB7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblxuICAgICAgICAgICAgdmFyIGhhc19hc2tlZCA9IEFWQ2FwdHVyZURldmljZS5hdXRob3JpemF0aW9uU3RhdHVzRm9yTWVkaWFUeXBlKEFWTWVkaWFUeXBlQXVkaW8pO1xuXG4gICAgICAgICAgICBpZiAoaGFzX2Fza2VkID09PSAyKSB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KCdtaWMgcGVybWlzc2lvbiBkZW5pZWQnKTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIEFWQXVkaW9TZXNzaW9uLnNoYXJlZEluc3RhbmNlKCkucmVxdWVzdFJlY29yZFBlcm1pc3Npb24oKGJvb2wpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoYm9vbCA9PT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGJvb2wpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJlamVjdCgnbWljIHBlcm1pc3Npb24gZGVuaWVkJyk7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0pXG5cbiAgICB9XG5cbiAgICBpb3NfY2FtZXJhX3Blcm1pc3Npb24oKTogUHJvbWlzZTxhbnk+IHtcblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuXG4gICAgICAgICAgICB2YXIgaGFzX2Fza2VkID0gQVZDYXB0dXJlRGV2aWNlLmF1dGhvcml6YXRpb25TdGF0dXNGb3JNZWRpYVR5cGUoQVZNZWRpYVR5cGVWaWRlbyk7XG5cbiAgICAgICAgICAgIGlmIChoYXNfYXNrZWQgPT09IDIpIHtcbiAgICAgICAgICAgICAgICByZWplY3QoJ2NhbWVyYSBwZXJtaXNzaW9uIGRlbmllZCcpO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgQVZDYXB0dXJlRGV2aWNlLnJlcXVlc3RBY2Nlc3NGb3JNZWRpYVR5cGVDb21wbGV0aW9uSGFuZGxlcihBVk1lZGlhVHlwZVZpZGVvLCAoYm9vbCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChib29sID09PSB0cnVlKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoYm9vbCk7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmVqZWN0KCdjYW1lcmEgcGVybWlzc2lvbiBkZW5pZWQnKTtcblxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgfSlcbiAgICB9XG5cblxuICAgIHB1YmxpYyBkaXNjb25uZWN0KCkge1xuXG4gICAgICAgIGlmICh0aGlzLnZpZGVvQWN0aXZpdHkucm9vbSkge1xuXG4gICAgICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuZGlzY29ubmVjdCgpO1xuXG4gICAgICAgIH1cblxuICAgIH1cblxuXG4gICAgcHVibGljIHRvZ2dsZV9sb2NhbF9hdWRpbygpIHtcblxuICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkudG9nZ2xlX2xvY2FsX2F1ZGlvKCk7XG5cbiAgICB9XG5cblxuICAgIHB1YmxpYyB0b2dnbGVfbG9jYWxfdmlkZW8oKSB7XG5cbiAgICAgICAgdGhpcy52aWRlb0FjdGl2aXR5LnRvZ2dsZV9sb2NhbF92aWRlbygpO1xuXG4gICAgfVxuXG4gICAgcHVibGljIGNvbm5lY3RfdG9fcm9vbSgpOiB2b2lkIHtcbiAgICAgICAgaWYgKCF0aGlzLmdldCgnbmFtZScpIHx8ICF0aGlzLmdldCgncm9vbScpIHx8IHRoaXMuZ2V0KCduYW1lJykubGVuZ3RoIDwgMSB8fCB0aGlzLmdldCgncm9vbScpLmxlbmd0aCA8IDEpXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zZXQoJ2Vycm9yJywgXCJNaXNzaW5nIEluZm8uXCIpO1xuICAgICAgICBlbHNlIHRoaXMuc2V0KCdlcnJvcicsIFwiXCIpO1xuICAgICAgICB0aGlzLmdldF90b2tlbigpXG4gICAgICAgICAgICAudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSByZXN1bHQuY29udGVudC50b0pTT04oKTtcbiAgICAgICAgICAgICAgICB0aGlzLnZpZGVvQWN0aXZpdHkuc2V0X2FjY2Vzc190b2tlbihyZXN1bHRbJ3Rva2VuJ10pO1xuICAgICAgICAgICAgICAgIHRoaXMudmlkZW9BY3Rpdml0eS5jb25uZWN0X3RvX3Jvb20odGhpcy5nZXQoJ3Jvb20nKSk7XG4gICAgICAgICAgICB9LCBlID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldCgnZXJyb3InLCBlKTtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuXG4gICAgcHVibGljIGdldF90b2tlbigpOiBQcm9taXNlPGFueT4ge1xuICAgICAgICBsZXQgbmFtZSA9IHRoaXMuZ2V0KCduYW1lJylcbiAgICAgICAgcmV0dXJuIGh0dHAucmVxdWVzdCh7XG4gICAgICAgICAgICB1cmw6IFwiaHR0cHM6Ly91cy1jZW50cmFsMS1maXJlYmFzZS1nb2JsdXIuY2xvdWRmdW5jdGlvbnMubmV0L2dldF90b2tlblwiLFxuICAgICAgICAgICAgbWV0aG9kOiBcIlBPU1RcIixcbiAgICAgICAgICAgIGhlYWRlcnM6IHsgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIgfSxcbiAgICAgICAgICAgIGNvbnRlbnQ6IEpTT04uc3RyaW5naWZ5KHsgdWlkOiBuYW1lIH0pXG4gICAgICAgIH0pO1xuICAgIH1cblxuXG59Il19